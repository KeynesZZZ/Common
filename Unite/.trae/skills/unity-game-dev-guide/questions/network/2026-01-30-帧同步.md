---
title: "å¸§åŒæ­¥"
date: "2026-01-30 12:30:00"
tags: [Unity, ç½‘ç»œç¼–ç¨‹, å¸§åŒæ­¥, æ¸¸æˆå¼€å‘]
difficulty: "é«˜çº§"
topic: "ç½‘ç»œç¼–ç¨‹"
project: "å¤šäººåœ¨çº¿æ¸¸æˆ"
skill_level: "é«˜çº§"
---

# å¸§åŒæ­¥

## é—®é¢˜æè¿°
> è¯·è¯¦ç»†è§£é‡Šæ¸¸æˆå¼€å‘ä¸­çš„å¸§åŒæ­¥æŠ€æœ¯ï¼ŒåŒ…æ‹¬å®ç°åŸç†ã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚

## å›ç­”

### 1. é—®é¢˜åˆ†æ
**æŠ€æœ¯èƒŒæ™¯**ï¼š
- å¸§åŒæ­¥æ˜¯ä¸€ç§ç½‘ç»œåŒæ­¥æŠ€æœ¯ï¼Œé€šè¿‡åœ¨æ‰€æœ‰å®¢æˆ·ç«¯ä¹‹é—´åŒæ­¥æ¸¸æˆé€»è¾‘å¸§å’Œç©å®¶è¾“å…¥ï¼Œä½¿æ‰€æœ‰å®¢æˆ·ç«¯è¿è¡Œç›¸åŒçš„æ¸¸æˆé€»è¾‘ï¼Œä»è€Œè¾¾åˆ°çŠ¶æ€ä¸€è‡´
- ä¸çŠ¶æ€åŒæ­¥ä¸åŒï¼Œå¸§åŒæ­¥ä¸ç›´æ¥ä¼ è¾“æ¸¸æˆçŠ¶æ€ï¼Œè€Œæ˜¯ä¼ è¾“ç©å®¶è¾“å…¥
- å¸§åŒæ­¥å¯ä»¥ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°å®Œå…¨ç›¸åŒçš„æ¸¸æˆè¿‡ç¨‹ï¼Œé€‚åˆéœ€è¦ç²¾ç¡®åŒæ­¥çš„æ¸¸æˆ
- å¸§åŒæ­¥çš„å®ç°ç›¸å¯¹å¤æ‚ï¼Œä½†å¯ä»¥å‡å°‘å¸¦å®½ä½¿ç”¨ï¼Œæé«˜æ¸¸æˆçš„å…¬å¹³æ€§

**æ ¹æœ¬åŸå› **ï¼š
- ç½‘ç»œå»¶è¿Ÿï¼šæ•°æ®åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å­˜åœ¨å»¶è¿Ÿï¼Œå¯¼è‡´ä¸åŒå®¢æˆ·ç«¯çš„è¾“å…¥å¤„ç†æ—¶é—´ä¸åŒæ­¥
- è¾“å…¥ä¸ä¸€è‡´ï¼šä¸åŒå®¢æˆ·ç«¯çš„è¾“å…¥å¯èƒ½åœ¨ä¸åŒçš„æ¸¸æˆå¸§è¢«å¤„ç†
- æµ®ç‚¹æ•°ç²¾åº¦ï¼šä¸åŒç¡¬ä»¶å’Œç¼–è¯‘å™¨çš„æµ®ç‚¹æ•°è®¡ç®—ç²¾åº¦å¯èƒ½ä¸åŒ
- éšæœºæ•°ç§å­ï¼šä¸åŒå®¢æˆ·ç«¯çš„éšæœºæ•°ç”Ÿæˆå¯èƒ½ä¸åŒæ­¥

**è§£å†³æ–¹æ¡ˆæ¦‚è¿°**ï¼š
- å®ç°å›ºå®šçš„æ¸¸æˆé€»è¾‘å¸§ç‡
- è®¾è®¡è¾“å…¥æ”¶é›†å’Œåˆ†å‘æœºåˆ¶
- å®ç°ç¡®å®šæ€§çš„æ¸¸æˆé€»è¾‘
- å¤„ç†ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…
- æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

**æŠ€æœ¯éš¾åº¦**ï¼šé«˜çº§
**é€‚ç”¨åœºæ™¯**ï¼šå®æ—¶å¤šäººæ¸¸æˆï¼Œç‰¹åˆ«æ˜¯éœ€è¦ç²¾ç¡®åŒæ­¥å’Œå…¬å¹³ç«æŠ€çš„æ¸¸æˆ
**å…³è”é¡¹ç›®**ï¼šç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰ã€å¤šäººåœ¨çº¿æˆ˜æ–— arenaï¼ˆMOBAï¼‰ã€æ ¼æ–—æ¸¸æˆ

### 2. æ¡ˆä¾‹æ¼”ç¤º

#### å¸§åŒæ­¥å®ç°

**1. æ¸¸æˆé€»è¾‘å¸§ç®¡ç†**
**å®ç°æ€è·¯**ï¼š
- è®¾è®¡å›ºå®šçš„æ¸¸æˆé€»è¾‘å¸§ç‡
- åˆ†ç¦»æ¸¸æˆé€»è¾‘æ›´æ–°å’Œæ¸²æŸ“æ›´æ–°
- ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯ä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œæ¸¸æˆé€»è¾‘

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class GameFrameManager : MonoBehaviour
{
    [SerializeField] private int targetFrameRate = 60; // æ¸²æŸ“å¸§ç‡
    [SerializeField] private int logicFrameRate = 30; // é€»è¾‘å¸§ç‡
    
    private float logicFrameInterval; // é€»è¾‘å¸§é—´éš”
    private float accumulatedTime; // ç´¯ç§¯æ—¶é—´
    private int currentLogicFrame; // å½“å‰é€»è¾‘å¸§
    
    public int CurrentLogicFrame => currentLogicFrame;
    public float LogicFrameInterval => logicFrameInterval;
    
    public event Action<int> OnLogicFrameUpdate; // é€»è¾‘å¸§æ›´æ–°äº‹ä»¶
    
    private void Start()
    {
        Application.targetFrameRate = targetFrameRate;
        logicFrameInterval = 1.0f / logicFrameRate;
        accumulatedTime = 0f;
        currentLogicFrame = 0;
    }
    
    private void Update()
    {
        // ç´¯ç§¯æ—¶é—´
        accumulatedTime += Time.deltaTime;
        
        // å¤„ç†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„é€»è¾‘å¸§
        while (accumulatedTime >= logicFrameInterval)
        {
            // æ‰§è¡Œé€»è¾‘å¸§æ›´æ–°
            currentLogicFrame++;
            OnLogicFrameUpdate?.Invoke(currentLogicFrame);
            
            // å‡å°‘ç´¯ç§¯æ—¶é—´
            accumulatedTime -= logicFrameInterval;
        }
    }
}
```

**2. è¾“å…¥ç®¡ç†**
**å®ç°æ€è·¯**ï¼š
- æ”¶é›†ç©å®¶è¾“å…¥å¹¶æ ‡è®°å¸§å·
- ç½‘ç»œä¼ è¾“è¾“å…¥æ•°æ®
- åœ¨æ‰€æœ‰å®¢æˆ·ç«¯ä¸Šä»¥ç›¸åŒçš„é¡ºåºå’Œæ—¶æœºå¤„ç†è¾“å…¥

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
[Serializable]
public class PlayerInput
{
    public int PlayerId { get; set; }
    public int Frame { get; set; } // è¾“å…¥æ‰€å±çš„é€»è¾‘å¸§
    public bool Jump { get; set; }
    public bool Attack { get; set; }
    public Vector2 MoveDirection { get; set; }
    public Vector2 LookDirection { get; set; }
    
    public PlayerInput(int playerId, int frame)
    {
        PlayerId = playerId;
        Frame = frame;
        Jump = false;
        Attack = false;
        MoveDirection = Vector2.zero;
        LookDirection = Vector2.zero;
    }
    
    public byte[] Serialize()
    {
        using (MemoryStream ms = new MemoryStream())
        using (BinaryWriter writer = new BinaryWriter(ms))
        {
            writer.Write(PlayerId);
            writer.Write(Frame);
            writer.Write(Jump);
            writer.Write(Attack);
            writer.Write(MoveDirection.x);
            writer.Write(MoveDirection.y);
            writer.Write(LookDirection.x);
            writer.Write(LookDirection.y);
            
            return ms.ToArray();
        }
    }
    
    public static PlayerInput Deserialize(byte[] data)
    {
        using (MemoryStream ms = new MemoryStream(data))
        using (BinaryReader reader = new BinaryReader(ms))
        {
            int playerId = reader.ReadInt32();
            int frame = reader.ReadInt32();
            bool jump = reader.ReadBoolean();
            bool attack = reader.ReadBoolean();
            Vector2 moveDirection = new Vector2(reader.ReadSingle(), reader.ReadSingle());
            Vector2 lookDirection = new Vector2(reader.ReadSingle(), reader.ReadSingle());
            
            PlayerInput input = new PlayerInput(playerId, frame)
            {
                Jump = jump,
                Attack = attack,
                MoveDirection = moveDirection,
                LookDirection = lookDirection
            };
            
            return input;
        }
    }
}

public class InputManager : MonoBehaviour
{
    private GameFrameManager frameManager;
    private Dictionary<int, PlayerInput> currentFrameInputs; // å½“å‰å¸§çš„è¾“å…¥
    private Queue<PlayerInput> pendingInputs; // å¾…å¤„ç†çš„è¾“å…¥
    private int localPlayerId = -1;
    
    public event Action<List<PlayerInput>> OnInputsProcessed; // è¾“å…¥å¤„ç†äº‹ä»¶
    
    private void Start()
    {
        frameManager = GetComponent<GameFrameManager>();
        currentFrameInputs = new Dictionary<int, PlayerInput>();
        pendingInputs = new Queue<PlayerInput>();
        
        // è®¢é˜…é€»è¾‘å¸§æ›´æ–°äº‹ä»¶
        frameManager.OnLogicFrameUpdate += ProcessInputs;
    }
    
    public void SetLocalPlayerId(int playerId)
    {
        localPlayerId = playerId;
    }
    
    private void Update()
    {
        // æ”¶é›†æœ¬åœ°ç©å®¶è¾“å…¥
        if (localPlayerId > 0)
        {
            CollectLocalInput();
        }
    }
    
    private void CollectLocalInput()
    {
        int currentFrame = frameManager.CurrentLogicFrame;
        
        // åˆ›å»ºæˆ–è·å–å½“å‰å¸§çš„è¾“å…¥
        if (!currentFrameInputs.TryGetValue(localPlayerId, out PlayerInput input))
        {
            input = new PlayerInput(localPlayerId, currentFrame);
            currentFrameInputs[localPlayerId] = input;
        }
        
        // æ”¶é›†è¾“å…¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
        input.Jump = Input.GetKeyDown(KeyCode.Space);
        input.Attack = Input.GetMouseButtonDown(0);
        input.MoveDirection = new Vector2(Input.GetAxisRaw("Horizontal"), Input.GetAxisRaw("Vertical"));
        input.LookDirection = new Vector2(Input.GetAxis("Mouse X"), Input.GetAxis("Mouse Y"));
    }
    
    private void ProcessInputs(int frame)
    {
        // å¤„ç†å½“å‰å¸§çš„æ‰€æœ‰è¾“å…¥
        List<PlayerInput> inputsToProcess = new List<PlayerInput>();
        
        // 1. æ·»åŠ æœ¬åœ°è¾“å…¥
        if (currentFrameInputs.TryGetValue(localPlayerId, out PlayerInput localInput) && localInput.Frame == frame)
        {
            inputsToProcess.Add(localInput);
            currentFrameInputs.Remove(localPlayerId);
        }
        
        // 2. æ·»åŠ ç½‘ç»œè¾“å…¥
        while (pendingInputs.Count > 0)
        {
            PlayerInput networkInput = pendingInputs.Peek();
            if (networkInput.Frame == frame)
            {
                inputsToProcess.Add(networkInput);
                pendingInputs.Dequeue();
            }
            else if (networkInput.Frame < frame)
            {
                // å¤„ç†è¿Ÿåˆ°çš„è¾“å…¥ï¼ˆå¯èƒ½éœ€è¦å›æ»šï¼‰
                Debug.LogWarning($"Late input received for frame {networkInput.Frame}, current frame is {frame}");
                pendingInputs.Dequeue();
            }
            else
            {
                // æœªæ¥çš„è¾“å…¥ï¼Œç­‰å¾…å¤„ç†
                break;
            }
        }
        
        // è§¦å‘è¾“å…¥å¤„ç†äº‹ä»¶
        OnInputsProcessed?.Invoke(inputsToProcess);
    }
    
    public void AddNetworkInput(PlayerInput input)
    {
        pendingInputs.Enqueue(input);
    }
    
    public PlayerInput GetCurrentLocalInput()
    {
        if (currentFrameInputs.TryGetValue(localPlayerId, out PlayerInput input))
        {
            return input;
        }
        return null;
    }
}
```

**3. æœåŠ¡å™¨ç«¯è¾“å…¥åˆ†å‘**
**å®ç°æ€è·¯**ï¼š
- æ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¾“å…¥
- æŒ‰å¸§å·ç»„ç»‡è¾“å…¥
- å¹¿æ’­è¾“å…¥åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
- å¤„ç†ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class ServerInputManager
{
    private Dictionary<int, Dictionary<int, PlayerInput>> frameInputs; // æŒ‰å¸§å·ç»„ç»‡çš„è¾“å…¥
    private int currentFrame; // å½“å‰å¸§
    private int inputCollectionWindow; // è¾“å…¥æ”¶é›†çª—å£ï¼ˆæ¯«ç§’ï¼‰
    
    public event Action<byte[]> OnInputBroadcast; // è¾“å…¥å¹¿æ’­äº‹ä»¶
    
    public ServerInputManager(int collectionWindow = 50)
    {
        frameInputs = new Dictionary<int, Dictionary<int, PlayerInput>>();
        currentFrame = 0;
        inputCollectionWindow = collectionWindow;
    }
    
    public void AddClientInput(PlayerInput input)
    {
        int frame = input.Frame;
        
        // ç¡®ä¿å¸§è¾“å…¥å­—å…¸å­˜åœ¨
        if (!frameInputs.ContainsKey(frame))
        {
            frameInputs[frame] = new Dictionary<int, PlayerInput>();
        }
        
        // æ·»åŠ æˆ–æ›´æ–°è¾“å…¥
        frameInputs[frame][input.PlayerId] = input;
    }
    
    public void Update()
    {
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¤„ç†å½“å‰å¸§çš„è¾“å…¥
        if (frameInputs.TryGetValue(currentFrame, out Dictionary<int, PlayerInput> inputs))
        {
            // å¹¿æ’­è¾“å…¥
            BroadcastInputs(currentFrame, inputs.Values.ToList());
            
            // ç§»é™¤å·²å¤„ç†çš„å¸§
            frameInputs.Remove(currentFrame);
            
            // æ¨è¿›åˆ°ä¸‹ä¸€å¸§
            currentFrame++;
        }
        else
        {
            // æ²¡æœ‰è¾“å…¥ï¼Œå¹¿æ’­ç©ºè¾“å…¥
            BroadcastInputs(currentFrame, new List<PlayerInput>());
            currentFrame++;
        }
    }
    
    private void BroadcastInputs(int frame, List<PlayerInput> inputs)
    {
        // åºåˆ—åŒ–è¾“å…¥æ•°æ®
        using (MemoryStream ms = new MemoryStream())
        using (BinaryWriter writer = new BinaryWriter(ms))
        {
            // å†™å…¥å¸§å·
            writer.Write(frame);
            
            // å†™å…¥è¾“å…¥æ•°é‡
            writer.Write(inputs.Count);
            
            // å†™å…¥æ¯ä¸ªè¾“å…¥
            foreach (PlayerInput input in inputs)
            {
                byte[] inputData = input.Serialize();
                writer.Write(inputData.Length);
                writer.Write(inputData);
            }
            
            // å¹¿æ’­æ•°æ®
            byte[] broadcastData = ms.ToArray();
            OnInputBroadcast?.Invoke(broadcastData);
        }
    }
    
    public int CurrentFrame => currentFrame;
}
```

**4. å®¢æˆ·ç«¯è¾“å…¥å¤„ç†**
**å®ç°æ€è·¯**ï¼š
- æ¥æ”¶æœåŠ¡å™¨å¹¿æ’­çš„è¾“å…¥
- æŒ‰å¸§å·ç¼“å­˜è¾“å…¥
- åœ¨æ­£ç¡®çš„é€»è¾‘å¸§å¤„ç†è¾“å…¥
- å¤„ç†ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class ClientInputProcessor : MonoBehaviour
{
    private InputManager inputManager;
    private Dictionary<int, List<PlayerInput>> frameInputBuffer; // å¸§è¾“å…¥ç¼“å†²åŒº
    private int lastProcessedFrame; // æœ€åå¤„ç†çš„å¸§
    
    private void Start()
    {
        inputManager = GetComponent<InputManager>();
        frameInputBuffer = new Dictionary<int, List<PlayerInput>>();
        lastProcessedFrame = -1;
    }
    
    public void HandleInputBroadcast(byte[] data)
    {
        using (MemoryStream ms = new MemoryStream(data))
        using (BinaryReader reader = new BinaryReader(ms))
        {
            // è¯»å–å¸§å·
            int frame = reader.ReadInt32();
            
            // è¯»å–è¾“å…¥æ•°é‡
            int inputCount = reader.ReadInt32();
            
            // è¯»å–æ¯ä¸ªè¾“å…¥
            List<PlayerInput> inputs = new List<PlayerInput>();
            for (int i = 0; i < inputCount; i++)
            {
                int inputLength = reader.ReadInt32();
                byte[] inputData = reader.ReadBytes(inputLength);
                PlayerInput input = PlayerInput.Deserialize(inputData);
                inputs.Add(input);
            }
            
            // æ·»åŠ åˆ°ç¼“å†²åŒº
            frameInputBuffer[frame] = inputs;
        }
    }
    
    public void Update()
    {
        int currentLogicFrame = GetComponent<GameFrameManager>().CurrentLogicFrame;
        
        // å¤„ç†æ‰€æœ‰å·²åˆ°è¾¾çš„ã€æœªå¤„ç†çš„å¸§è¾“å…¥
        while (lastProcessedFrame < currentLogicFrame - 1)
        {
            int nextFrame = lastProcessedFrame + 1;
            
            if (frameInputBuffer.TryGetValue(nextFrame, out List<PlayerInput> inputs))
            {
                // å¤„ç†è¾“å…¥
                foreach (PlayerInput input in inputs)
                {
                    inputManager.AddNetworkInput(input);
                }
                
                // ç§»é™¤å·²å¤„ç†çš„è¾“å…¥
                frameInputBuffer.Remove(nextFrame);
                lastProcessedFrame = nextFrame;
            }
            else
            {
                // æ²¡æœ‰æ”¶åˆ°è¯¥å¸§çš„è¾“å…¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œå»¶è¿Ÿ
                Debug.LogWarning($"Missing input for frame {nextFrame}");
                break;
            }
        }
    }
}
```

**5. ç¡®å®šæ€§æ¸¸æˆé€»è¾‘**
**å®ç°æ€è·¯**ï¼š
- ç¡®ä¿æ¸¸æˆé€»è¾‘çš„ç¡®å®šæ€§
- ä½¿ç”¨å›ºå®šçš„éšæœºæ•°ç§å­
- é¿å…ä½¿ç”¨éç¡®å®šæ€§çš„å‡½æ•°å’Œåº“
- å¤„ç†æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class DeterministicGameLogic
{
    private Dictionary<int, PlayerState> playerStates;
    private DeterministicRandom random;
    private int currentFrame;
    
    public DeterministicGameLogic(int seed)
    {
        playerStates = new Dictionary<int, PlayerState>();
        random = new DeterministicRandom(seed);
        currentFrame = 0;
    }
    
    public void AddPlayer(int playerId, Vector3 spawnPosition)
    {
        playerStates[playerId] = new PlayerState(playerId, spawnPosition, Quaternion.identity);
    }
    
    public void RemovePlayer(int playerId)
    {
        playerStates.Remove(playerId);
    }
    
    public void ProcessFrame(int frame, List<PlayerInput> inputs)
    {
        currentFrame = frame;
        
        // è®¾ç½®éšæœºæ•°ç§å­ï¼ˆåŸºäºå¸§å·ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯ç›¸åŒï¼‰
        random.SetSeed(frame);
        
        // å¤„ç†æ¯ä¸ªè¾“å…¥
        foreach (PlayerInput input in inputs)
        {
            if (playerStates.TryGetValue(input.PlayerId, out PlayerState state))
            {
                ProcessPlayerInput(state, input);
            }
        }
        
        // æ›´æ–°æ‰€æœ‰ç©å®¶çŠ¶æ€
        foreach (PlayerState state in playerStates.Values)
        {
            UpdatePlayerState(state);
        }
    }
    
    private void ProcessPlayerInput(PlayerState state, PlayerInput input)
    {
        // å¤„ç†ç§»åŠ¨è¾“å…¥
        const float moveSpeed = 5f;
        float deltaTime = 1.0f / 30f; // å‡è®¾30fpsé€»è¾‘å¸§
        
        Vector3 moveDirection = new Vector3(input.MoveDirection.x, 0, input.MoveDirection.y);
        moveDirection.Normalize();
        
        state.Position += moveDirection * moveSpeed * deltaTime;
        
        // å¤„ç†æ—‹è½¬è¾“å…¥
        if (input.LookDirection.sqrMagnitude > 0)
        {
            float rotateSpeed = 180f;
            Vector3 rotateDirection = new Vector3(0, input.LookDirection.x, 0);
            
            state.Rotation *= Quaternion.Euler(rotateDirection * rotateSpeed * deltaTime);
        }
        
        // å¤„ç†è·³è·ƒè¾“å…¥
        if (input.Jump && state.IsGrounded)
        {
            const float jumpForce = 8f;
            state.Velocity = new Vector3(state.Velocity.x, jumpForce, state.Velocity.z);
            state.IsGrounded = false;
        }
        
        // å¤„ç†æ”»å‡»è¾“å…¥
        if (input.Attack)
        {
            // æ‰§è¡Œæ”»å‡»é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
            state.IsAttacking = true;
            state.AttackStartTime = currentFrame;
        }
    }
    
    private void UpdatePlayerState(PlayerState state)
    {
        // åº”ç”¨é‡åŠ›
        const float gravity = 9.81f;
        float deltaTime = 1.0f / 30f;
        
        state.Velocity = new Vector3(state.Velocity.x, state.Velocity.y - gravity * deltaTime, state.Velocity.z);
        
        // æ›´æ–°ä½ç½®
        state.Position += state.Velocity * deltaTime;
        
        // ç®€å•çš„åœ°é¢æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        if (state.Position.y <= 0)
        {
            state.Position = new Vector3(state.Position.x, 0, state.Position.z);
            state.Velocity = new Vector3(state.Velocity.x, 0, state.Velocity.z);
            state.IsGrounded = true;
        }
        else
        {
            state.IsGrounded = false;
        }
        
        // æ›´æ–°æ”»å‡»çŠ¶æ€
        if (state.IsAttacking && currentFrame - state.AttackStartTime > 10) // 10å¸§æ”»å‡»åŠ¨ç”»
        {
            state.IsAttacking = false;
        }
    }
    
    public PlayerState GetPlayerState(int playerId)
    {
        if (playerStates.TryGetValue(playerId, out PlayerState state))
        {
            return state;
        }
        return null;
    }
}

// ç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆå™¨
public class DeterministicRandom
{
    private int seed;
    private int currentSeed;
    
    public DeterministicRandom(int seed)
    {
        this.seed = seed;
        currentSeed = seed;
    }
    
    public void SetSeed(int newSeed)
    {
        currentSeed = newSeed ^ seed; // ä¸åˆå§‹ç§å­å¼‚æˆ–ï¼Œç¡®ä¿ä¸åŒå¸§çš„ç§å­ä¸åŒ
    }
    
    public int Next()
    {
        // ç®€å•çš„çº¿æ€§åŒä½™ç”Ÿæˆå™¨
        currentSeed = (currentSeed * 1103515245 + 12345) % 2147483647;
        return currentSeed;
    }
    
    public float NextFloat()
    {
        return Next() / (float)2147483647;
    }
    
    public float NextFloat(float min, float max)
    {
        return min + NextFloat() * (max - min);
    }
}

// ç©å®¶çŠ¶æ€
public class PlayerState
{
    public int PlayerId { get; set; }
    public Vector3 Position { get; set; }
    public Quaternion Rotation { get; set; }
    public Vector3 Velocity { get; set; }
    public bool IsGrounded { get; set; }
    public bool IsAttacking { get; set; }
    public int AttackStartTime { get; set; }
    
    public PlayerState(int playerId, Vector3 position, Quaternion rotation)
    {
        PlayerId = playerId;
        Position = position;
        Rotation = rotation;
        Velocity = Vector3.zero;
        IsGrounded = true;
        IsAttacking = false;
        AttackStartTime = 0;
    }
}
```

**å®ç°è¯´æ˜**ï¼š
- **æ¸¸æˆé€»è¾‘å¸§ç®¡ç†**ï¼šåˆ†ç¦»æ¸¸æˆé€»è¾‘æ›´æ–°å’Œæ¸²æŸ“æ›´æ–°ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯ä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œæ¸¸æˆé€»è¾‘
- **è¾“å…¥ç®¡ç†**ï¼šæ”¶é›†å’Œå¤„ç†ç©å®¶è¾“å…¥ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯åœ¨ç›¸åŒçš„å¸§å¤„ç†ç›¸åŒçš„è¾“å…¥
- **æœåŠ¡å™¨ç«¯è¾“å…¥åˆ†å‘**ï¼šæ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¾“å…¥å¹¶å¹¿æ’­åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
- **å®¢æˆ·ç«¯è¾“å…¥å¤„ç†**ï¼šæ¥æ”¶æœåŠ¡å™¨å¹¿æ’­çš„è¾“å…¥å¹¶åœ¨æ­£ç¡®çš„å¸§å¤„ç†
- **ç¡®å®šæ€§æ¸¸æˆé€»è¾‘**ï¼šç¡®ä¿æ¸¸æˆé€»è¾‘çš„ç¡®å®šæ€§ï¼Œä½¿ç”¨å›ºå®šçš„éšæœºæ•°ç§å­

### 3. æ³¨æ„äº‹é¡¹
**å…³é”®è¦ç‚¹**ï¼š
- ğŸ“Œ å›ºå®šé€»è¾‘å¸§ç‡ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯ä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œæ¸¸æˆé€»è¾‘
- ğŸ“Œ ç¡®å®šæ€§é€»è¾‘ï¼šç¡®ä¿æ¸¸æˆé€»è¾‘çš„ç¡®å®šæ€§ï¼Œé¿å…ä½¿ç”¨éç¡®å®šæ€§çš„å‡½æ•°
- ğŸ“Œ è¾“å…¥åŒæ­¥ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯åœ¨ç›¸åŒçš„å¸§å¤„ç†ç›¸åŒçš„è¾“å…¥
- ğŸ“Œ éšæœºæ•°ç§å­ï¼šä½¿ç”¨åŸºäºå¸§å·çš„éšæœºæ•°ç§å­ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çš„éšæœºæ•°ç”ŸæˆåŒæ­¥
- ğŸ“Œ æµ®ç‚¹æ•°ç²¾åº¦ï¼šå¤„ç†ä¸åŒç¡¬ä»¶å’Œç¼–è¯‘å™¨çš„æµ®ç‚¹æ•°è®¡ç®—ç²¾åº¦å·®å¼‚
- ğŸ“Œ ç½‘ç»œå»¶è¿Ÿï¼šå¤„ç†ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ï¼Œç¡®ä¿æ¸¸æˆçš„æµç•…æ€§

**ä¼˜åŒ–å»ºè®®**ï¼š
- ğŸš€ è¾“å…¥é¢„æµ‹ï¼šåœ¨ç­‰å¾…æœåŠ¡å™¨è¾“å…¥æ—¶ï¼Œé¢„æµ‹æœ¬åœ°ç©å®¶çš„è¾“å…¥
- ğŸš€ å¸§æ’å€¼ï¼šåœ¨æ¸²æŸ“æ—¶ï¼Œå¯¹æ¸¸æˆçŠ¶æ€è¿›è¡Œæ’å€¼ï¼Œæé«˜è§†è§‰æµç•…åº¦
- ğŸš€ å¸¦å®½ä¼˜åŒ–ï¼šå‹ç¼©è¾“å…¥æ•°æ®ï¼Œå‡å°‘å¸¦å®½ä½¿ç”¨
- ğŸš€ é”™è¯¯æ¢å¤ï¼šå®ç°å¸§å›æ»šå’ŒçŠ¶æ€åŒæ­¥æœºåˆ¶ï¼Œå¤„ç†ä¸¥é‡çš„ç½‘ç»œé”™è¯¯
- ğŸš€ å¹¶è¡Œè®¡ç®—ï¼šä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†æ¸¸æˆé€»è¾‘ï¼Œæé«˜æ€§èƒ½

**è·¨å¹³å°è€ƒé‡**ï¼š
- ä¸åŒå¹³å°çš„ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå¯èƒ½æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹æ€§ï¼Œéœ€è¦ç¡®ä¿æ¸¸æˆé€»è¾‘åœ¨æ‰€æœ‰å¹³å°ä¸Šä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œ
- ç§»åŠ¨å¹³å°çš„ç½‘ç»œç¯å¢ƒä¸ç¨³å®šï¼Œéœ€è¦æ›´å¥å£®çš„é”™è¯¯å¤„ç†
- WebGLå¹³å°çš„JavaScriptæ‰§è¡Œç¯å¢ƒå¯èƒ½ä¸åŸç”Ÿå¹³å°æœ‰å·®å¼‚ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç¡®å®šæ€§

**è®°å¿†è¦ç‚¹**ï¼š
- å¸§åŒæ­¥çš„æ ¸å¿ƒæ˜¯åŒæ­¥è¾“å…¥è€Œä¸æ˜¯çŠ¶æ€
- ç¡®å®šæ€§æ¸¸æˆé€»è¾‘æ˜¯å¸§åŒæ­¥çš„åŸºç¡€
- å›ºå®šçš„æ¸¸æˆé€»è¾‘å¸§ç‡ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯è¿è¡Œç›¸åŒçš„æ¸¸æˆé€»è¾‘
- è¾“å…¥é¢„æµ‹å’Œå¸§æ’å€¼å¯ä»¥æé«˜ç©å®¶ä½“éªŒ
- å¸§åŒæ­¥å¯ä»¥ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°å®Œå…¨ç›¸åŒçš„æ¸¸æˆè¿‡ç¨‹

### 4. å®ç°åŸç†
**åº•å±‚å®ç°**ï¼š
- **é€»è¾‘å¸§åŒæ­¥**ï¼šæ‰€æœ‰å®¢æˆ·ç«¯ä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œæ¸¸æˆé€»è¾‘
- **è¾“å…¥åˆ†å‘**ï¼šæœåŠ¡å™¨æ”¶é›†å¹¶å¹¿æ’­æ‰€æœ‰å®¢æˆ·ç«¯çš„è¾“å…¥
- **ç¡®å®šæ€§è®¡ç®—**ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çš„æ¸¸æˆé€»è¾‘è®¡ç®—ç»“æœç›¸åŒ
- **ç½‘ç»œè¡¥å¿**ï¼šå¤„ç†ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```
// ç©å®¶è¾“å…¥
class PlayerInput {
    int PlayerId;
    int Frame;
    bool Jump;
    bool Attack;
    Vector2 MoveDirection;
    Vector2 LookDirection;
}

// ç©å®¶çŠ¶æ€
class PlayerState {
    int PlayerId;
    Vector3 Position;
    Quaternion Rotation;
    Vector3 Velocity;
    bool IsGrounded;
    bool IsAttacking;
    int AttackStartTime;
}

// å¸§è¾“å…¥æ˜ å°„
Dictionary<int, Dictionary<int, PlayerInput>> frameInputs;

// ç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆå™¨
class DeterministicRandom {
    int seed;
    int currentSeed;
    // éšæœºæ•°ç”Ÿæˆæ–¹æ³•
}
```

**æ ¸å¿ƒé€»è¾‘æµç¨‹**ï¼š
1. **è¾“å…¥æ”¶é›†**ï¼š
   - å®¢æˆ·ç«¯æ”¶é›†ç©å®¶è¾“å…¥å¹¶æ ‡è®°å¸§å·
   - å®¢æˆ·ç«¯å°†è¾“å…¥å‘é€åˆ°æœåŠ¡å™¨

2. **è¾“å…¥åˆ†å‘**ï¼š
   - æœåŠ¡å™¨æ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¾“å…¥
   - æœåŠ¡å™¨æŒ‰å¸§å·ç»„ç»‡è¾“å…¥
   - æœåŠ¡å™¨å¹¿æ’­è¾“å…¥åˆ°æ‰€æœ‰å®¢æˆ·ç«¯

3. **è¾“å…¥å¤„ç†**ï¼š
   - å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡å™¨å¹¿æ’­çš„è¾“å…¥
   - å®¢æˆ·ç«¯æŒ‰å¸§å·ç¼“å­˜è¾“å…¥
   - å®¢æˆ·ç«¯åœ¨æ­£ç¡®çš„é€»è¾‘å¸§å¤„ç†è¾“å…¥

4. **æ¸¸æˆé€»è¾‘**ï¼š
   - æ‰€æœ‰å®¢æˆ·ç«¯ä»¥ç›¸åŒçš„é€Ÿç‡è¿è¡Œæ¸¸æˆé€»è¾‘
   - æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒçš„è¾“å…¥å’Œéšæœºæ•°ç§å­
   - æ‰€æœ‰å®¢æˆ·ç«¯æ‰§è¡Œç›¸åŒçš„æ¸¸æˆé€»è¾‘è®¡ç®—

5. **æ¸²æŸ“**ï¼š
   - å®¢æˆ·ç«¯æ ¹æ®æ¸¸æˆçŠ¶æ€è¿›è¡Œæ¸²æŸ“
   - å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨å¸§æ’å€¼æé«˜è§†è§‰æµç•…åº¦

### 5. çŸ¥è¯†ç‚¹æ€»ç»“
**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- å¸§åŒæ­¥ï¼šé€šè¿‡åŒæ­¥æ¸¸æˆé€»è¾‘å¸§å’Œç©å®¶è¾“å…¥ï¼Œä½¿æ‰€æœ‰å®¢æˆ·ç«¯è¿è¡Œç›¸åŒçš„æ¸¸æˆé€»è¾‘
- ç¡®å®šæ€§æ¸¸æˆé€»è¾‘ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çš„æ¸¸æˆé€»è¾‘è®¡ç®—ç»“æœç›¸åŒ
- é€»è¾‘å¸§ç‡ï¼šå›ºå®šçš„æ¸¸æˆé€»è¾‘æ›´æ–°é€Ÿç‡
- è¾“å…¥é¢„æµ‹ï¼šåœ¨ç­‰å¾…æœåŠ¡å™¨è¾“å…¥æ—¶ï¼Œé¢„æµ‹æœ¬åœ°ç©å®¶çš„è¾“å…¥
- å¸§æ’å€¼ï¼šåœ¨æ¸²æŸ“æ—¶ï¼Œå¯¹æ¸¸æˆçŠ¶æ€è¿›è¡Œæ’å€¼ï¼Œæé«˜è§†è§‰æµç•…åº¦

**æŠ€æœ¯è¦ç‚¹**ï¼š
- æ¸¸æˆé€»è¾‘å¸§ç®¡ç†ï¼šåˆ†ç¦»æ¸¸æˆé€»è¾‘æ›´æ–°å’Œæ¸²æŸ“æ›´æ–°
- è¾“å…¥æ”¶é›†å’Œåˆ†å‘ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯åœ¨ç›¸åŒçš„å¸§å¤„ç†ç›¸åŒçš„è¾“å…¥
- ç¡®å®šæ€§æ¸¸æˆé€»è¾‘ï¼šé¿å…ä½¿ç”¨éç¡®å®šæ€§çš„å‡½æ•°å’Œåº“
- éšæœºæ•°ç§å­åŒæ­¥ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çš„éšæœºæ•°ç”Ÿæˆç›¸åŒ
- ç½‘ç»œå»¶è¿Ÿå¤„ç†ï¼šä½¿ç”¨è¾“å…¥é¢„æµ‹å’Œå¸§æ’å€¼å‡å°‘å»¶è¿Ÿå½±å“

**åº”ç”¨åœºæ™¯**ï¼š
- ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰ï¼šéœ€è¦ç²¾ç¡®çš„å°„å‡»åˆ¤å®šå’Œå…¬å¹³ç«æŠ€
- å¤šäººåœ¨çº¿æˆ˜æ–— arenaï¼ˆMOBAï¼‰ï¼šéœ€è¦ç²¾ç¡®çš„æŠ€èƒ½é‡Šæ”¾å’Œå‘½ä¸­åˆ¤å®š
- æ ¼æ–—æ¸¸æˆï¼šéœ€è¦ç²¾ç¡®çš„æ‹›å¼åˆ¤å®šå’Œè¿æ‹›ç³»ç»Ÿ
- ä»»ä½•éœ€è¦å…¬å¹³ç«æŠ€çš„å®æ—¶å¤šäººæ¸¸æˆ

**å­¦ä¹ å»ºè®®**ï¼š
- æ·±å…¥ç†è§£æ¸¸æˆå¾ªç¯å’Œå¸§ç‡ç®¡ç†
- å­¦ä¹ ç¡®å®šæ€§ç®—æ³•å’Œéšæœºæ•°ç”Ÿæˆ
- å®è·µç¼–å†™å®Œæ•´çš„å¸§åŒæ­¥ä»£ç 
- æµ‹è¯•åœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹çš„æ€§èƒ½å’Œå¯é æ€§
- ç ”ç©¶æ¸¸æˆå¼€å‘ä¸­å¸¸ç”¨çš„å¸§åŒæ­¥åº“çš„å®ç°

**è¿›é˜¶è·¯å¾„**ï¼š
- å­¦ä¹ çŠ¶æ€åŒæ­¥å’Œå¸§åŒæ­¥çš„æ··åˆä½¿ç”¨
- ç ”ç©¶ç½‘ç»œç¼–ç å’Œå‹ç¼©æŠ€æœ¯
- äº†è§£äº‘æ¸¸æˆä¸­çš„å¸§åŒæ­¥æŒ‘æˆ˜
- å­¦ä¹ äººå·¥æ™ºèƒ½åœ¨è¾“å…¥é¢„æµ‹ä¸­çš„åº”ç”¨
- ç ”ç©¶5Gç½‘ç»œå¯¹å¸§åŒæ­¥çš„å½±å“

### 6. é¡¹ç›®å®è·µ
**é¡¹ç›®æ¡ˆä¾‹**ï¼š
- **å¤šäººåœ¨çº¿æˆ˜æ–— arenaï¼ˆMOBAï¼‰**ï¼šä½¿ç”¨å¸§åŒæ­¥ç¡®ä¿æ‰€æœ‰ç©å®¶çœ‹åˆ°ç›¸åŒçš„æŠ€èƒ½é‡Šæ”¾å’Œå‘½ä¸­åˆ¤å®š
- **ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰**ï¼šä½¿ç”¨å¸§åŒæ­¥ç¡®ä¿ç²¾ç¡®çš„å°„å‡»åˆ¤å®šå’Œå¼¹é“è®¡ç®—
- **æ ¼æ–—æ¸¸æˆ**ï¼šä½¿ç”¨å¸§åŒæ­¥ç¡®ä¿ç²¾ç¡®çš„æ‹›å¼åˆ¤å®šå’Œè¿æ‹›ç³»ç»Ÿ
- **å®æ—¶æˆ˜ç•¥æ¸¸æˆï¼ˆRTSï¼‰**ï¼šä½¿ç”¨å¸§åŒæ­¥ç¡®ä¿æ‰€æœ‰ç©å®¶çœ‹åˆ°ç›¸åŒçš„å•ä½ç§»åŠ¨å’Œæˆ˜æ–—ç»“æœ

**å¼€å‘æµç¨‹**ï¼š
1. **éœ€æ±‚åˆ†æ**ï¼šç¡®å®šæ¸¸æˆæ˜¯å¦é€‚åˆä½¿ç”¨å¸§åŒæ­¥
2. **æŠ€æœ¯é€‰å‹**ï¼šé€‰æ‹©åˆé€‚çš„ç½‘ç»œåè®®å’ŒåŒæ­¥ç­–ç•¥
3. **æ¶æ„è®¾è®¡**ï¼šè®¾è®¡æ¸¸æˆé€»è¾‘å¸§ç®¡ç†å’Œè¾“å…¥å¤„ç†æœºåˆ¶
4. **å®ç°åŸå‹**ï¼šç¼–å†™åŸºæœ¬çš„å¸§åŒæ­¥ä»£ç 
5. **æµ‹è¯•éªŒè¯**ï¼šåœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹æµ‹è¯•åŒæ­¥è´¨é‡å’Œæ€§èƒ½
6. **ä¼˜åŒ–è°ƒæ•´**ï¼šæ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ–åŒæ­¥å‚æ•°å’Œå®ç°
7. **é›†æˆä¸Šçº¿**ï¼šå°†å¸§åŒæ­¥ç³»ç»Ÿé›†æˆåˆ°æ¸¸æˆä¸­å¹¶å‘å¸ƒ

**æœ€ä½³å®è·µ**ï¼š
- **åˆ†å±‚è®¾è®¡**ï¼šå°†ç½‘ç»œåŒæ­¥é€»è¾‘ä¸æ¸¸æˆé€»è¾‘åˆ†ç¦»
- **å¯é…ç½®æ€§**ï¼šä½¿åŒæ­¥å‚æ•°å¯é…ç½®ï¼Œé€‚åº”ä¸åŒçš„ç½‘ç»œç¯å¢ƒ
- **ç›‘æ§å’Œåˆ†æ**ï¼šå®ç°å¸§åŒæ­¥çš„ç›‘æ§å’Œåˆ†æå·¥å…·
- **é”™è¯¯å¤„ç†**ï¼šå®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
- **æ–‡æ¡£åŒ–**ï¼šè¯¦ç»†è®°å½•å¸§åŒæ­¥çš„è®¾è®¡å’Œå®ç°ç»†èŠ‚

### 7. ç½‘ç»œæœç´¢ç»“æœ
**ç›¸å…³èµ„æ–™**ï¼š
- æ¸¸æˆç½‘ç»œç¼–ç¨‹ç²¾è¦ - Glenn Fiedler
- ã€Š1500 Archers on a 28.8: Network Programming in Age of Empires and Beyondã€‹- Grady Booch
- Unityå®˜æ–¹ç½‘ç»œç¼–ç¨‹æ–‡æ¡£
- ã€ŠNetworked Physicsã€‹- Glenn Fiedler

**ä¿¡æ¯éªŒè¯**ï¼š
- å¸§åŒæ­¥æ˜¯å¤šäººæ¸¸æˆå¼€å‘ä¸­çš„æ ‡å‡†å®è·µï¼Œå·²åœ¨å¤šä¸ªæˆåŠŸçš„æ¸¸æˆä¸­å¾—åˆ°éªŒè¯
- ç¡®å®šæ€§æ¸¸æˆé€»è¾‘æ˜¯å¸§åŒæ­¥çš„åŸºç¡€ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„
- è¾“å…¥é¢„æµ‹å’Œå¸§æ’å€¼å¯ä»¥æ˜¾è‘—æé«˜ç©å®¶ä½“éªŒ

**æƒå¨æ¥æº**ï¼š
- Glenn Fiedlerçš„ç½‘ç»œç¼–ç¨‹æ–‡ç« ï¼šhttps://gafferongames.com/
- Unity Documentationï¼šhttps://docs.unity3d.com/Manual/UNet.html
- Valveå¼€å‘è€…æ–‡æ¡£ï¼šhttps://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking
