---
title: "å»¶è¿Ÿè¡¥å¿"
date: "2026-01-30 13:00:00"
tags: [Unity, ç½‘ç»œç¼–ç¨‹, å»¶è¿Ÿè¡¥å¿, æ¸¸æˆå¼€å‘]
difficulty: "é«˜çº§"
topic: "ç½‘ç»œç¼–ç¨‹"
project: "å¤šäººåœ¨çº¿æ¸¸æˆ"
skill_level: "é«˜çº§"
---

# å»¶è¿Ÿè¡¥å¿

## é—®é¢˜æè¿°
> è¯·è¯¦ç»†è§£é‡Šæ¸¸æˆå¼€å‘ä¸­çš„å»¶è¿Ÿè¡¥å¿æŠ€æœ¯ï¼ŒåŒ…æ‹¬å®ç°åŸç†ã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚

## å›ç­”

### 1. é—®é¢˜åˆ†æ
**æŠ€æœ¯èƒŒæ™¯**ï¼š
- ç½‘ç»œå»¶è¿Ÿæ˜¯åœ¨çº¿æ¸¸æˆä¸­ä¸å¯é¿å…çš„é—®é¢˜ï¼Œæ•°æ®ä»å®¢æˆ·ç«¯ä¼ è¾“åˆ°æœåŠ¡å™¨å†è¿”å›éœ€è¦ä¸€å®šæ—¶é—´
- åœ¨ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰ç­‰éœ€è¦ç²¾ç¡®æ“ä½œçš„æ¸¸æˆä¸­ï¼Œç½‘ç»œå»¶è¿Ÿä¼šå¯¼è‡´ç©å®¶ä½“éªŒä¸ä½³
- ä¾‹å¦‚ï¼Œå½“ç©å®¶ç„å‡†å¹¶å°„å‡»ä¸€ä¸ªç§»åŠ¨çš„ç›®æ ‡æ—¶ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿï¼ŒæœåŠ¡å™¨æ”¶åˆ°å°„å‡»æŒ‡ä»¤æ—¶ï¼Œç›®æ ‡å¯èƒ½å·²ç»ç§»åŠ¨åˆ°äº†æ–°çš„ä½ç½®
- å»¶è¿Ÿè¡¥å¿æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç©å®¶æ„Ÿè§‰ä¸åˆ°ç½‘ç»œå»¶è¿Ÿçš„å½±å“

**æ ¹æœ¬åŸå› **ï¼š
- ç½‘ç»œå»¶è¿Ÿï¼šæ•°æ®åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å­˜åœ¨å»¶è¿Ÿ
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çŠ¶æ€ä¸åŒæ­¥ï¼šæœåŠ¡å™¨å¤„ç†è¾“å…¥æ—¶ï¼Œå®¢æˆ·ç«¯çš„æ˜¾ç¤ºçŠ¶æ€ä¸æœåŠ¡å™¨çš„å®é™…çŠ¶æ€å­˜åœ¨å·®å¼‚
- å‘½ä¸­åˆ¤å®šä¸å‡†ç¡®ï¼šåŸºäºæœåŠ¡å™¨å½“å‰çŠ¶æ€çš„å‘½ä¸­åˆ¤å®šå¯èƒ½ä¸å®¢æˆ·ç«¯çœ‹åˆ°çš„æƒ…å†µä¸ç¬¦

**è§£å†³æ–¹æ¡ˆæ¦‚è¿°**ï¼š
- è®°å½•å®¢æˆ·ç«¯è¾“å…¥çš„æ—¶é—´æˆ³
- æœåŠ¡å™¨ä¿å­˜å†å²æ¸¸æˆçŠ¶æ€
- å½“å¤„ç†å®¢æˆ·ç«¯è¾“å…¥æ—¶ï¼Œå›æ»šåˆ°è¾“å…¥å‘é€æ—¶çš„æ¸¸æˆçŠ¶æ€
- åœ¨å›æ»šçŠ¶æ€ä¸‹æ‰§è¡Œå‘½ä¸­åˆ¤å®š
- å°†ç»“æœåº”ç”¨åˆ°å½“å‰æ¸¸æˆçŠ¶æ€
- æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

**æŠ€æœ¯éš¾åº¦**ï¼šé«˜çº§
**é€‚ç”¨åœºæ™¯**ï¼šå®æ—¶å¤šäººæ¸¸æˆï¼Œç‰¹åˆ«æ˜¯éœ€è¦ç²¾ç¡®å‘½ä¸­åˆ¤å®šçš„æ¸¸æˆ
**å…³è”é¡¹ç›®**ï¼šç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰ã€ç¬¬ä¸‰äººç§°å°„å‡»æ¸¸æˆï¼ˆTPSï¼‰ã€å°„å‡»ç±»æ¸¸æˆ

### 2. æ¡ˆä¾‹æ¼”ç¤º

#### å»¶è¿Ÿè¡¥å¿å®ç°

**1. æ¸¸æˆçŠ¶æ€è®°å½•**
**å®ç°æ€è·¯**ï¼š
- æœåŠ¡å™¨è®°å½•æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ¸¸æˆçŠ¶æ€
- æ¯ä¸ªçŠ¶æ€åŒ…å«æ—¶é—´æˆ³å’Œæ‰€æœ‰æ¸¸æˆå¯¹è±¡çš„ä½ç½®ã€æ—‹è½¬ç­‰ä¿¡æ¯
- ä½¿ç”¨å¾ªç¯ç¼“å†²åŒºå­˜å‚¨å†å²çŠ¶æ€ï¼Œé™åˆ¶å†…å­˜ä½¿ç”¨

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class GameStateHistory
{
    private struct HistoryEntry
    {
        public int Timestamp; // æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        public Dictionary<int, PlayerState> PlayerStates; // ç©å®¶çŠ¶æ€
        public Dictionary<int, GameObjectState> GameObjectStates; // å…¶ä»–æ¸¸æˆå¯¹è±¡çŠ¶æ€
    }
    
    [SerializeField] private int maxHistorySize = 100; // æœ€å¤§å†å²è®°å½•æ•°é‡
    private Queue<HistoryEntry> history; // å†å²çŠ¶æ€é˜Ÿåˆ—
    private Dictionary<int, PlayerState> currentPlayerStates; // å½“å‰ç©å®¶çŠ¶æ€
    private Dictionary<int, GameObjectState> currentGameObjectStates; // å½“å‰æ¸¸æˆå¯¹è±¡çŠ¶æ€
    
    public GameStateHistory()
    {
        history = new Queue<HistoryEntry>();
        currentPlayerStates = new Dictionary<int, PlayerState>();
        currentGameObjectStates = new Dictionary<int, GameObjectState>();
    }
    
    public void AddPlayer(int playerId, Vector3 position)
    {
        currentPlayerStates[playerId] = new PlayerState(playerId, position, Quaternion.identity);
    }
    
    public void RemovePlayer(int playerId)
    {
        currentPlayerStates.Remove(playerId);
    }
    
    public void AddGameObject(int objectId, Vector3 position, Quaternion rotation)
    {
        currentGameObjectStates[objectId] = new GameObjectState(objectId, position, rotation);
    }
    
    public void RemoveGameObject(int objectId)
    {
        currentGameObjectStates.Remove(objectId);
    }
    
    public void UpdatePlayerState(int playerId, Vector3 position, Quaternion rotation)
    {
        if (currentPlayerStates.TryGetValue(playerId, out PlayerState state))
        {
            state.Position = position;
            state.Rotation = rotation;
        }
    }
    
    public void UpdateGameObjectState(int objectId, Vector3 position, Quaternion rotation)
    {
        if (currentGameObjectStates.TryGetValue(objectId, out GameObjectState state))
        {
            state.Position = position;
            state.Rotation = rotation;
        }
    }
    
    public void RecordState(int timestamp)
    {
        // åˆ›å»ºçŠ¶æ€å‰¯æœ¬
        Dictionary<int, PlayerState> playerStatesCopy = new Dictionary<int, PlayerState>();
        foreach (var kvp in currentPlayerStates)
        {
            PlayerState original = kvp.Value;
            playerStatesCopy[kvp.Key] = new PlayerState(original.PlayerId, original.Position, original.Rotation)
            {
                Health = original.Health,
                Velocity = original.Velocity
            };
        }
        
        Dictionary<int, GameObjectState> gameObjectStatesCopy = new Dictionary<int, GameObjectState>();
        foreach (var kvp in currentGameObjectStates)
        {
            GameObjectState original = kvp.Value;
            gameObjectStatesCopy[kvp.Key] = new GameObjectState(original.ObjectId, original.Position, original.Rotation)
            {
                Velocity = original.Velocity
            };
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        history.Enqueue(new HistoryEntry
        {
            Timestamp = timestamp,
            PlayerStates = playerStatesCopy,
            GameObjectStates = gameObjectStatesCopy
        });
        
        // é™åˆ¶å†å²è®°å½•å¤§å°
        while (history.Count > maxHistorySize)
        {
            history.Dequeue();
        }
    }
    
    public HistoryEntry? GetStateAtTime(int timestamp)
    {
        // æ‰¾åˆ°æœ€æ¥è¿‘æŒ‡å®šæ—¶é—´çš„å†å²çŠ¶æ€
        HistoryEntry? bestMatch = null;
        int smallestTimeDiff = int.MaxValue;
        
        foreach (var entry in history)
        {
            int timeDiff = Math.Abs(entry.Timestamp - timestamp);
            if (timeDiff < smallestTimeDiff)
            {
                smallestTimeDiff = timeDiff;
                bestMatch = entry;
            }
        }
        
        return bestMatch;
    }
    
    public Dictionary<int, PlayerState> CurrentPlayerStates => currentPlayerStates;
    public Dictionary<int, GameObjectState> CurrentGameObjectStates => currentGameObjectStates;
}

// ç©å®¶çŠ¶æ€
public class PlayerState
{
    public int PlayerId { get; set; }
    public Vector3 Position { get; set; }
    public Quaternion Rotation { get; set; }
    public float Health { get; set; }
    public Vector3 Velocity { get; set; }
    
    public PlayerState(int playerId, Vector3 position, Quaternion rotation)
    {
        PlayerId = playerId;
        Position = position;
        Rotation = rotation;
        Health = 100f;
        Velocity = Vector3.zero;
    }
}

// æ¸¸æˆå¯¹è±¡çŠ¶æ€
public class GameObjectState
{
    public int ObjectId { get; set; }
    public Vector3 Position { get; set; }
    public Quaternion Rotation { get; set; }
    public Vector3 Velocity { get; set; }
    
    public GameObjectState(int objectId, Vector3 position, Quaternion rotation)
    {
        ObjectId = objectId;
        Position = position;
        Rotation = rotation;
        Velocity = Vector3.zero;
    }
}
```

**2. è¾“å…¥å¤„ç†ä¸çŠ¶æ€å›æ»š**
**å®ç°æ€è·¯**ï¼š
- æœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯è¾“å…¥ï¼ŒåŒ…å«æ—¶é—´æˆ³
- æ ¹æ®è¾“å…¥æ—¶é—´æˆ³ï¼Œå›æ»šåˆ°å¯¹åº”çš„å†å²æ¸¸æˆçŠ¶æ€
- åœ¨å›æ»šçŠ¶æ€ä¸‹æ‰§è¡Œè¾“å…¥å¤„ç†ï¼ˆå¦‚å°„å‡»ï¼‰
- å°†ç»“æœåº”ç”¨åˆ°å½“å‰æ¸¸æˆçŠ¶æ€

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class LagCompensationSystem
{
    private GameStateHistory stateHistory;
    private int serverTimeOffset; // æœåŠ¡å™¨æ—¶é—´ä¸å®¢æˆ·ç«¯æ—¶é—´çš„åç§»
    
    public LagCompensationSystem(GameStateHistory history)
    {
        stateHistory = history;
        serverTimeOffset = 0;
    }
    
    public void ProcessShootInput(int playerId, Vector3 shootDirection, int clientTimestamp)
    {
        // è®¡ç®—æœåŠ¡å™¨æ—¶é—´æˆ³
        int serverTimestamp = clientTimestamp + serverTimeOffset;
        
        // è·å–è¾“å…¥å‘é€æ—¶çš„æ¸¸æˆçŠ¶æ€
        var historicalState = stateHistory.GetStateAtTime(serverTimestamp);
        
        if (historicalState.HasValue)
        {
            // æ‰§è¡Œå»¶è¿Ÿè¡¥å¿çš„å°„å‡»åˆ¤å®š
            PerformLagCompensatedShoot(playerId, shootDirection, historicalState.Value);
        }
        else
        {
            // æ²¡æœ‰æ‰¾åˆ°å†å²çŠ¶æ€ï¼Œä½¿ç”¨å½“å‰çŠ¶æ€
            PerformNormalShoot(playerId, shootDirection);
        }
    }
    
    private void PerformLagCompensatedShoot(int shooterId, Vector3 shootDirection, GameStateHistory.HistoryEntry historicalState)
    {
        // è·å–å°„æ‰‹åœ¨å†å²çŠ¶æ€ä¸­çš„ä½ç½®
        if (!historicalState.PlayerStates.TryGetValue(shooterId, out PlayerState shooterState))
        {
            return;
        }
        
        // è®¡ç®—å°„å‡»å°„çº¿
        Ray ray = new Ray(shooterState.Position, shootDirection);
        RaycastHit hit;
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­å…¶ä»–ç©å®¶
        foreach (var kvp in historicalState.PlayerStates)
        {
            int targetId = kvp.Key;
            PlayerState targetState = kvp.Value;
            
            // è·³è¿‡è‡ªå·±
            if (targetId == shooterId)
            {
                continue;
            }
            
            // ç®€åŒ–çš„å‘½ä¸­æ£€æµ‹ï¼ˆå®é™…åº”ä½¿ç”¨æ›´å¤æ‚çš„ç¢°æ’æ£€æµ‹ï¼‰
            Vector3 directionToTarget = targetState.Position - shooterState.Position;
            float distanceToTarget = directionToTarget.magnitude;
            directionToTarget.Normalize();
            
            float dotProduct = Vector3.Dot(shootDirection, directionToTarget);
            
            // å¦‚æœæ–¹å‘æ¥è¿‘ï¼Œä¸”åœ¨æœ‰æ•ˆå°„ç¨‹å†…
            if (dotProduct > 0.95f && distanceToTarget < 100f)
            {
                // å‘½ä¸­ï¼åº”ç”¨ä¼¤å®³åˆ°å½“å‰çŠ¶æ€
                ApplyDamageToCurrentState(targetId, 25f);
                Debug.Log($"Lag compensated hit: Player {shooterId} hit Player {targetId} at historical position");
                break;
            }
        }
    }
    
    private void PerformNormalShoot(int shooterId, Vector3 shootDirection)
    {
        // ä½¿ç”¨å½“å‰çŠ¶æ€æ‰§è¡Œå°„å‡»åˆ¤å®šï¼ˆæ ‡å‡†æ–¹å¼ï¼‰
        if (!stateHistory.CurrentPlayerStates.TryGetValue(shooterId, out PlayerState shooterState))
        {
            return;
        }
        
        // è®¡ç®—å°„å‡»å°„çº¿
        Ray ray = new Ray(shooterState.Position, shootDirection);
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­å…¶ä»–ç©å®¶
        foreach (var kvp in stateHistory.CurrentPlayerStates)
        {
            int targetId = kvp.Key;
            PlayerState targetState = kvp.Value;
            
            // è·³è¿‡è‡ªå·±
            if (targetId == shooterId)
            {
                continue;
            }
            
            // ç®€åŒ–çš„å‘½ä¸­æ£€æµ‹
            Vector3 directionToTarget = targetState.Position - shooterState.Position;
            float distanceToTarget = directionToTarget.magnitude;
            directionToTarget.Normalize();
            
            float dotProduct = Vector3.Dot(shootDirection, directionToTarget);
            
            // å¦‚æœæ–¹å‘æ¥è¿‘ï¼Œä¸”åœ¨æœ‰æ•ˆå°„ç¨‹å†…
            if (dotProduct > 0.95f && distanceToTarget < 100f)
            {
                // å‘½ä¸­ï¼åº”ç”¨ä¼¤å®³
                ApplyDamageToCurrentState(targetId, 25f);
                Debug.Log($"Normal hit: Player {shooterId} hit Player {targetId}");
                break;
            }
        }
    }
    
    private void ApplyDamageToCurrentState(int playerId, float damage)
    {
        if (stateHistory.CurrentPlayerStates.TryGetValue(playerId, out PlayerState state))
        {
            state.Health = Mathf.Max(0, state.Health - damage);
            
            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
            if (state.Health <= 0)
            {
                Debug.Log($"Player {playerId} died!");
                // å¤„ç†æ­»äº¡é€»è¾‘
            }
        }
    }
    
    public void UpdateServerTimeOffset(int offset)
    {
        serverTimeOffset = offset;
    }
}
```

**3. å®¢æˆ·ç«¯æ—¶é—´åŒæ­¥**
**å®ç°æ€è·¯**ï¼š
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®šæœŸäº¤æ¢æ—¶é—´æˆ³
- è®¡ç®—ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é—´åç§»
- å®¢æˆ·ç«¯è°ƒæ•´æœ¬åœ°æ—¶é—´æˆ³ï¼Œä½¿å…¶ä¸æœåŠ¡å™¨æ—¶é—´åŒæ­¥

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class TimeSyncManager : MonoBehaviour
{
    [SerializeField] private float syncInterval = 5.0f; // åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰
    private float lastSyncTime;
    private int serverTimeOffset; // æœåŠ¡å™¨æ—¶é—´åç§»
    private int lastRoundTripTime; // æœ€åä¸€æ¬¡å¾€è¿”æ—¶é—´
    
    public int ServerTimeOffset => serverTimeOffset;
    public int LastRoundTripTime => lastRoundTripTime;
    
    private void Start()
    {
        lastSyncTime = 0f;
        serverTimeOffset = 0;
        lastRoundTripTime = 0;
    }
    
    private void Update()
    {
        lastSyncTime += Time.deltaTime;
        
        if (lastSyncTime >= syncInterval)
        {
            lastSyncTime = 0f;
            RequestTimeSync();
        }
    }
    
    private void RequestTimeSync()
    {
        int clientSendTime = GetCurrentTimestamp();
        
        // å‘é€æ—¶é—´åŒæ­¥è¯·æ±‚åˆ°æœåŠ¡å™¨
        // è¿™é‡Œåº”è¯¥æ˜¯ç½‘ç»œå‘é€ä»£ç 
        // ServerConnection.SendTimeSyncRequest(clientSendTime);
        
        // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”
        StartCoroutine(SimulateServerResponse(clientSendTime));
    }
    
    private IEnumerator SimulateServerResponse(int clientSendTime)
    {
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        yield return new WaitForSeconds(Random.Range(0.05f, 0.2f));
        
        int serverTime = GetCurrentTimestamp();
        int clientReceiveTime = GetCurrentTimestamp();
        
        // è®¡ç®—å¾€è¿”æ—¶é—´å’Œæ—¶é—´åç§»
        int roundTripTime = clientReceiveTime - clientSendTime;
        int estimatedOneWayTime = roundTripTime / 2;
        int newOffset = serverTime - (clientSendTime + estimatedOneWayTime);
        
        // å¹³æ»‘è°ƒæ•´æ—¶é—´åç§»
        serverTimeOffset = (serverTimeOffset * 3 + newOffset) / 4;
        lastRoundTripTime = roundTripTime;
        
        Debug.Log($"Time sync: Offset = {serverTimeOffset}ms, RTT = {roundTripTime}ms");
    }
    
    public int GetCurrentTimestamp()
    {
        return (int)(DateTimeOffset.UtcNow.ToUnixTimeMilliseconds());
    }
    
    public int GetServerTimestamp()
    {
        return GetCurrentTimestamp() + serverTimeOffset;
    }
}
```

**4. å®¢æˆ·ç«¯å°„å‡»è¾“å…¥å¤„ç†**
**å®ç°æ€è·¯**ï¼š
- å®¢æˆ·ç«¯è®°å½•å°„å‡»è¾“å…¥çš„æ—¶é—´æˆ³
- å‘é€å°„å‡»è¾“å…¥å’Œæ—¶é—´æˆ³åˆ°æœåŠ¡å™¨
- æœåŠ¡å™¨ä½¿ç”¨æ—¶é—´æˆ³æ‰§è¡Œå»¶è¿Ÿè¡¥å¿çš„å‘½ä¸­åˆ¤å®š

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class ClientShootManager : MonoBehaviour
{
    [SerializeField] private Camera playerCamera;
    [SerializeField] private TimeSyncManager timeSyncManager;
    private bool isShooting = false;
    
    private void Update()
    {
        if (Input.GetMouseButtonDown(0))
        {
            StartShooting();
        }
        
        if (Input.GetMouseButton(0))
        {
            ContinueShooting();
        }
        
        if (Input.GetMouseButtonUp(0))
        {
            StopShooting();
        }
    }
    
    private void StartShooting()
    {
        isShooting = true;
        FireShot();
    }
    
    private void ContinueShooting()
    {
        if (isShooting)
        {
            // å¯ä»¥æ·»åŠ å°„é€Ÿé™åˆ¶
            FireShot();
        }
    }
    
    private void StopShooting()
    {
        isShooting = false;
    }
    
    private void FireShot()
    {
        // è®¡ç®—å°„å‡»æ–¹å‘
        Ray ray = playerCamera.ScreenPointToRay(new Vector3(Screen.width / 2, Screen.height / 2, 0));
        Vector3 shootDirection = ray.direction;
        
        // è·å–å½“å‰æœåŠ¡å™¨æ—¶é—´æˆ³
        int serverTimestamp = timeSyncManager.GetServerTimestamp();
        
        // å‘é€å°„å‡»è¯·æ±‚åˆ°æœåŠ¡å™¨
        SendShootRequest(shootDirection, serverTimestamp);
        
        // æœ¬åœ°é¢„æµ‹å°„å‡»æ•ˆæœ
        PredictShootEffect(shootDirection);
    }
    
    private void SendShootRequest(Vector3 direction, int timestamp)
    {
        // è¿™é‡Œåº”è¯¥æ˜¯ç½‘ç»œå‘é€ä»£ç 
        // ServerConnection.SendShootRequest(direction, timestamp);
        
        Debug.Log($"Sent shoot request: Direction = {direction}, Timestamp = {timestamp}");
    }
    
    private void PredictShootEffect(Vector3 direction)
    {
        // æœ¬åœ°é¢„æµ‹å°„å‡»æ•ˆæœï¼Œå¦‚æªå£é—ªå…‰ã€å£°éŸ³ç­‰
        // å®é™…å‘½ä¸­ç»“æœç”±æœåŠ¡å™¨å†³å®š
        Debug.Log("Predicted shoot effect");
    }
}
```

**5. æœåŠ¡å™¨å°„å‡»å¤„ç†**
**å®ç°æ€è·¯**ï¼š
- æœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯çš„å°„å‡»è¯·æ±‚
- æå–å°„å‡»æ–¹å‘å’Œæ—¶é—´æˆ³
- ä½¿ç”¨å»¶è¿Ÿè¡¥å¿ç³»ç»Ÿå¤„ç†å°„å‡»
- å¹¿æ’­å‘½ä¸­ç»“æœåˆ°æ‰€æœ‰å®¢æˆ·ç«¯

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
public class ServerShootManager
{
    private LagCompensationSystem lagCompensation;
    
    public ServerShootManager(LagCompensationSystem lagComp)
    {
        lagCompensation = lagComp;
    }
    
    public void HandleShootRequest(int playerId, Vector3 shootDirection, int timestamp)
    {
        // ä½¿ç”¨å»¶è¿Ÿè¡¥å¿å¤„ç†å°„å‡»
        lagCompensation.ProcessShootInput(playerId, shootDirection, timestamp);
        
        // å¹¿æ’­å°„å‡»ç»“æœåˆ°æ‰€æœ‰å®¢æˆ·ç«¯
        // è¿™é‡Œåº”è¯¥æ˜¯ç½‘ç»œå¹¿æ’­ä»£ç 
        // NetworkManager.BroadcastShootResult(playerId, hitInfo, timestamp);
    }
}
```

**å®ç°è¯´æ˜**ï¼š
- **æ¸¸æˆçŠ¶æ€è®°å½•**ï¼šæœåŠ¡å™¨è®°å½•æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ¸¸æˆçŠ¶æ€ï¼Œç”¨äºå›æ»š
- **è¾“å…¥å¤„ç†ä¸çŠ¶æ€å›æ»š**ï¼šæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯è¾“å…¥çš„æ—¶é—´æˆ³ï¼Œå›æ»šåˆ°å¯¹åº”çš„å†å²çŠ¶æ€æ‰§è¡Œå‘½ä¸­åˆ¤å®š
- **å®¢æˆ·ç«¯æ—¶é—´åŒæ­¥**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®šæœŸäº¤æ¢æ—¶é—´æˆ³ï¼Œè®¡ç®—ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é—´åç§»
- **å®¢æˆ·ç«¯å°„å‡»è¾“å…¥å¤„ç†**ï¼šå®¢æˆ·ç«¯è®°å½•å°„å‡»è¾“å…¥çš„æ—¶é—´æˆ³å¹¶å‘é€åˆ°æœåŠ¡å™¨
- **æœåŠ¡å™¨å°„å‡»å¤„ç†**ï¼šæœåŠ¡å™¨ä½¿ç”¨å»¶è¿Ÿè¡¥å¿ç³»ç»Ÿå¤„ç†å°„å‡»è¯·æ±‚

### 3. æ³¨æ„äº‹é¡¹
**å…³é”®è¦ç‚¹**ï¼š
- ğŸ“Œ æ—¶é—´æˆ³åŒæ­¥ï¼šç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ—¶é—´æˆ³åŒæ­¥ï¼Œæ˜¯å»¶è¿Ÿè¡¥å¿çš„åŸºç¡€
- ğŸ“Œ å†å²çŠ¶æ€ç®¡ç†ï¼šæœåŠ¡å™¨éœ€è¦ä¿å­˜è¶³å¤Ÿçš„å†å²çŠ¶æ€ï¼ŒåŒæ—¶é¿å…å†…å­˜ä½¿ç”¨è¿‡é«˜
- ğŸ“Œ å‘½ä¸­åˆ¤å®šå‡†ç¡®æ€§ï¼šåœ¨å›æ»šçŠ¶æ€ä¸‹çš„å‘½ä¸­åˆ¤å®šéœ€è¦ä¸å®¢æˆ·ç«¯çœ‹åˆ°çš„æƒ…å†µä¸€è‡´
- ğŸ“Œ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿè¡¥å¿ä¼šå¢åŠ æœåŠ¡å™¨çš„è®¡ç®—è´Ÿæ‹…ï¼Œéœ€è¦ä¼˜åŒ–å®ç°
- ğŸ“Œ é˜²ä½œå¼Šï¼šéœ€è¦é˜²æ­¢æ¶æ„å®¢æˆ·ç«¯å‘é€è™šå‡çš„æ—¶é—´æˆ³
- ğŸ“Œ ç½‘ç»œæŠ–åŠ¨ï¼šå¤„ç†ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„æ—¶é—´æˆ³ä¸å‡†ç¡®é—®é¢˜

**ä¼˜åŒ–å»ºè®®**ï¼š
- ğŸš€ çŠ¶æ€å‹ç¼©ï¼šå‹ç¼©å†å²çŠ¶æ€æ•°æ®ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨
- ğŸš€ é¢„æµ‹ä¼˜åŒ–ï¼šå®¢æˆ·ç«¯é¢„æµ‹å°„å‡»æ•ˆæœï¼Œå‡å°‘æœåŠ¡å™¨ç¡®è®¤çš„å»¶è¿Ÿæ„Ÿ
- ğŸš€ å¹¶è¡Œè®¡ç®—ï¼šä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†å»¶è¿Ÿè¡¥å¿çš„å‘½ä¸­åˆ¤å®š
- ğŸš€ çŠ¶æ€æ’å€¼ï¼šåœ¨å›æ»šçŠ¶æ€æ—¶ä½¿ç”¨æ’å€¼ï¼Œæé«˜å‡†ç¡®æ€§
- ğŸš€ æ™ºèƒ½å›æ»šï¼šåªå›æ»šä¸å°„å‡»ç›¸å…³çš„æ¸¸æˆå¯¹è±¡ï¼Œå‡å°‘è®¡ç®—é‡

**è·¨å¹³å°è€ƒé‡**ï¼š
- ä¸åŒå¹³å°çš„ç½‘ç»œç¯å¢ƒå·®å¼‚è¾ƒå¤§ï¼Œéœ€è¦é’ˆå¯¹ä¸åŒå¹³å°è°ƒæ•´å»¶è¿Ÿè¡¥å¿å‚æ•°
- ç§»åŠ¨å¹³å°çš„ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜ä¸”ä¸ç¨³å®šï¼Œéœ€è¦æ›´å¥å£®çš„å»¶è¿Ÿè¡¥å¿å®ç°
- ä¸»æœºå¹³å°çš„ç½‘ç»œç¨³å®šæ€§è¾ƒå¥½ï¼Œå¯ä»¥é€‚å½“å‡å°‘å†å²çŠ¶æ€çš„ä¿å­˜æ—¶é—´

**è®°å¿†è¦ç‚¹**ï¼š
- å»¶è¿Ÿè¡¥å¿çš„æ ¸å¿ƒæ˜¯å›æ»šåˆ°è¾“å…¥å‘é€æ—¶çš„æ¸¸æˆçŠ¶æ€æ‰§è¡Œå‘½ä¸­åˆ¤å®š
- æ—¶é—´æˆ³åŒæ­¥æ˜¯å»¶è¿Ÿè¡¥å¿çš„åŸºç¡€
- å†å²çŠ¶æ€ç®¡ç†éœ€è¦å¹³è¡¡å†…å­˜ä½¿ç”¨å’Œå›æ»šå‡†ç¡®æ€§
- å»¶è¿Ÿè¡¥å¿å¯ä»¥æ˜¾è‘—æé«˜ç©å®¶ä½“éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å»¶è¿Ÿç½‘ç»œç¯å¢ƒä¸‹
- å»¶è¿Ÿè¡¥å¿éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å®ç°ï¼Œå®¢æˆ·ç«¯åªè´Ÿè´£å‘é€å¸¦æ—¶é—´æˆ³çš„è¾“å…¥

### 4. å®ç°åŸç†
**åº•å±‚å®ç°**ï¼š
- **æ—¶é—´åŒæ­¥**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡äº¤æ¢æ—¶é—´æˆ³å®ç°æ—¶é—´åŒæ­¥
- **çŠ¶æ€è®°å½•**ï¼šæœåŠ¡å™¨è®°å½•æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ¸¸æˆçŠ¶æ€
- **çŠ¶æ€å›æ»š**ï¼šæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯è¾“å…¥çš„æ—¶é—´æˆ³ï¼Œå›æ»šåˆ°å¯¹åº”çš„å†å²çŠ¶æ€
- **å‘½ä¸­åˆ¤å®š**ï¼šåœ¨å›æ»šçŠ¶æ€ä¸‹æ‰§è¡Œå‘½ä¸­åˆ¤å®šï¼Œç¡®ä¿ä¸å®¢æˆ·ç«¯çœ‹åˆ°çš„æƒ…å†µä¸€è‡´
- **ç»“æœåº”ç”¨**ï¼šå°†å‘½ä¸­ç»“æœåº”ç”¨åˆ°å½“å‰æ¸¸æˆçŠ¶æ€

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```
// å†å²çŠ¶æ€æ¡ç›®
struct HistoryEntry {
    int Timestamp; // æ—¶é—´æˆ³
    Dictionary<int, PlayerState> PlayerStates; // ç©å®¶çŠ¶æ€
    Dictionary<int, GameObjectState> GameObjectStates; // æ¸¸æˆå¯¹è±¡çŠ¶æ€
}

// ç©å®¶çŠ¶æ€
class PlayerState {
    int PlayerId;
    Vector3 Position;
    Quaternion Rotation;
    float Health;
    Vector3 Velocity;
}

// æ¸¸æˆå¯¹è±¡çŠ¶æ€
class GameObjectState {
    int ObjectId;
    Vector3 Position;
    Quaternion Rotation;
    Vector3 Velocity;
}

// å†å²çŠ¶æ€é˜Ÿåˆ—
Queue<HistoryEntry> history;
```

**æ ¸å¿ƒé€»è¾‘æµç¨‹**ï¼š
1. **æ—¶é—´åŒæ­¥**ï¼š
   - å®¢æˆ·ç«¯å‘é€æ—¶é—´åŒæ­¥è¯·æ±‚åˆ°æœåŠ¡å™¨
   - æœåŠ¡å™¨è¿”å›å½“å‰æ—¶é—´æˆ³
   - å®¢æˆ·ç«¯è®¡ç®—ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é—´åç§»
   - å®¢æˆ·ç«¯è°ƒæ•´æœ¬åœ°æ—¶é—´æˆ³

2. **çŠ¶æ€è®°å½•**ï¼š
   - æœåŠ¡å™¨å®šæœŸè®°å½•æ¸¸æˆçŠ¶æ€
   - æ¯ä¸ªçŠ¶æ€åŒ…å«æ—¶é—´æˆ³å’Œæ‰€æœ‰æ¸¸æˆå¯¹è±¡çš„çŠ¶æ€
   - ä½¿ç”¨å¾ªç¯ç¼“å†²åŒºå­˜å‚¨å†å²çŠ¶æ€

3. **å°„å‡»å¤„ç†**ï¼š
   - å®¢æˆ·ç«¯è®°å½•å°„å‡»è¾“å…¥çš„æ—¶é—´æˆ³
   - å®¢æˆ·ç«¯å‘é€å°„å‡»è¯·æ±‚å’Œæ—¶é—´æˆ³åˆ°æœåŠ¡å™¨
   - æœåŠ¡å™¨æå–å°„å‡»æ–¹å‘å’Œæ—¶é—´æˆ³
   - æœåŠ¡å™¨è·å–è¾“å…¥å‘é€æ—¶çš„æ¸¸æˆçŠ¶æ€
   - æœåŠ¡å™¨åœ¨å†å²çŠ¶æ€ä¸‹æ‰§è¡Œå‘½ä¸­åˆ¤å®š
   - æœåŠ¡å™¨å°†ç»“æœåº”ç”¨åˆ°å½“å‰çŠ¶æ€
   - æœåŠ¡å™¨å¹¿æ’­å‘½ä¸­ç»“æœåˆ°æ‰€æœ‰å®¢æˆ·ç«¯

4. **ç»“æœåº”ç”¨**ï¼š
   - å®¢æˆ·ç«¯æ¥æ”¶å‘½ä¸­ç»“æœ
   - å®¢æˆ·ç«¯æ˜¾ç¤ºå‘½ä¸­æ•ˆæœ
   - å®¢æˆ·ç«¯æ›´æ–°æ¸¸æˆçŠ¶æ€

### 5. çŸ¥è¯†ç‚¹æ€»ç»“
**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- å»¶è¿Ÿè¡¥å¿ï¼šé€šè¿‡å›æ»šåˆ°è¾“å…¥å‘é€æ—¶çš„æ¸¸æˆçŠ¶æ€ï¼Œæ‰§è¡Œå‘½ä¸­åˆ¤å®šï¼Œè§£å†³ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„å‘½ä¸­åˆ¤å®šä¸å‡†ç¡®é—®é¢˜
- æ—¶é—´åŒæ­¥ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡äº¤æ¢æ—¶é—´æˆ³ï¼Œè®¡ç®—ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é—´åç§»ï¼Œå®ç°æ—¶é—´åŒæ­¥
- çŠ¶æ€å›æ»šï¼šæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯è¾“å…¥çš„æ—¶é—´æˆ³ï¼Œå›æ»šåˆ°å¯¹åº”çš„å†å²çŠ¶æ€æ‰§è¡Œæ“ä½œ
- å†å²çŠ¶æ€ç®¡ç†ï¼šæœåŠ¡å™¨è®°å½•æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ¸¸æˆçŠ¶æ€ï¼Œç”¨äºå›æ»š

**æŠ€æœ¯è¦ç‚¹**ï¼š
- æ¸¸æˆçŠ¶æ€è®°å½•ï¼šæœåŠ¡å™¨éœ€è¦è®°å½•è¶³å¤Ÿçš„å†å²çŠ¶æ€ï¼ŒåŒæ—¶é™åˆ¶å†…å­˜ä½¿ç”¨
- æ—¶é—´åŒæ­¥ï¼šå‡†ç¡®è®¡ç®—ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é—´åç§»ï¼Œç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ—¶é—´åŒæ­¥
- çŠ¶æ€å›æ»šï¼šé«˜æ•ˆåœ°å›æ»šåˆ°å†å²çŠ¶æ€å¹¶æ‰§è¡Œæ“ä½œ
- å‘½ä¸­åˆ¤å®šï¼šåœ¨å›æ»šçŠ¶æ€ä¸‹å‡†ç¡®æ‰§è¡Œå‘½ä¸­åˆ¤å®š
- ç»“æœåº”ç”¨ï¼šå°†å›æ»šçŠ¶æ€ä¸‹çš„æ“ä½œç»“æœæ­£ç¡®åº”ç”¨åˆ°å½“å‰çŠ¶æ€

**åº”ç”¨åœºæ™¯**ï¼š
- ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼ˆFPSï¼‰ï¼šéœ€è¦ç²¾ç¡®çš„å°„å‡»åˆ¤å®š
- ç¬¬ä¸‰äººç§°å°„å‡»æ¸¸æˆï¼ˆTPSï¼‰ï¼šéœ€è¦ç²¾ç¡®çš„å°„å‡»åˆ¤å®š
- ä»»ä½•éœ€è¦ç²¾ç¡®æ“ä½œçš„å®æ—¶å¤šäººæ¸¸æˆ

**å­¦ä¹ å»ºè®®**ï¼š
- æ·±å…¥ç†è§£ç½‘ç»œå»¶è¿Ÿçš„å½±å“
- å­¦ä¹ æ¸¸æˆçŠ¶æ€ç®¡ç†å’Œè®°å½•æŠ€æœ¯
- å®è·µç¼–å†™å®Œæ•´çš„å»¶è¿Ÿè¡¥å¿ä»£ç 
- æµ‹è¯•åœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹çš„æ€§èƒ½å’Œå¯é æ€§
- ç ”ç©¶æ¸¸æˆå¼€å‘ä¸­å¸¸ç”¨çš„å»¶è¿Ÿè¡¥å¿åº“çš„å®ç°

**è¿›é˜¶è·¯å¾„**ï¼š
- å­¦ä¹ é«˜çº§çš„æ—¶é—´åŒæ­¥ç®—æ³•
- ç ”ç©¶çŠ¶æ€å‹ç¼©å’Œä¼˜åŒ–æŠ€æœ¯
- äº†è§£å…¶ä»–ç±»å‹æ¸¸æˆçš„å»¶è¿Ÿè¡¥å¿å®ç°
- å­¦ä¹ ç½‘ç»œé¢„æµ‹å’Œæ’å€¼æŠ€æœ¯
- ç ”ç©¶5Gç½‘ç»œå¯¹å»¶è¿Ÿè¡¥å¿çš„å½±å“

### 6. é¡¹ç›®å®è·µ
**é¡¹ç›®æ¡ˆä¾‹**ï¼š
- **ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆ**ï¼šä½¿ç”¨å»¶è¿Ÿè¡¥å¿ç¡®ä¿ç²¾ç¡®çš„å°„å‡»åˆ¤å®š
- **ç¬¬ä¸‰äººç§°å°„å‡»æ¸¸æˆ**ï¼šä½¿ç”¨å»¶è¿Ÿè¡¥å¿ç¡®ä¿ç²¾ç¡®çš„å°„å‡»åˆ¤å®š
- **ä»»ä½•éœ€è¦ç²¾ç¡®æ“ä½œçš„å®æ—¶å¤šäººæ¸¸æˆ**ï¼šä½¿ç”¨å»¶è¿Ÿè¡¥å¿æé«˜ç©å®¶ä½“éªŒ

**å¼€å‘æµç¨‹**ï¼š
1. **éœ€æ±‚åˆ†æ**ï¼šç¡®å®šæ¸¸æˆæ˜¯å¦éœ€è¦å»¶è¿Ÿè¡¥å¿ï¼Œä»¥åŠéœ€è¦çš„ç²¾åº¦
2. **æŠ€æœ¯é€‰å‹**ï¼šé€‰æ‹©åˆé€‚çš„æ—¶é—´åŒæ­¥å’ŒçŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
3. **æ¶æ„è®¾è®¡**ï¼šè®¾è®¡æ¸¸æˆçŠ¶æ€è®°å½•å’Œå›æ»šæœºåˆ¶
4. **å®ç°åŸå‹**ï¼šç¼–å†™åŸºæœ¬çš„å»¶è¿Ÿè¡¥å¿ä»£ç 
5. **æµ‹è¯•éªŒè¯**ï¼šåœ¨ä¸åŒç½‘ç»œæ¡ä»¶ä¸‹æµ‹è¯•å»¶è¿Ÿè¡¥å¿çš„æ•ˆæœ
6. **ä¼˜åŒ–è°ƒæ•´**ï¼šæ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ–å»¶è¿Ÿè¡¥å¿å‚æ•°å’Œå®ç°
7. **é›†æˆä¸Šçº¿**ï¼šå°†å»¶è¿Ÿè¡¥å¿ç³»ç»Ÿé›†æˆåˆ°æ¸¸æˆä¸­å¹¶å‘å¸ƒ

**æœ€ä½³å®è·µ**ï¼š
- **æ—¶é—´åŒæ­¥ç²¾åº¦**ï¼šç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ—¶é—´åŒæ­¥ç²¾åº¦åœ¨æ¯«ç§’çº§
- **å†å²çŠ¶æ€ç®¡ç†**ï¼šæ ¹æ®æ¸¸æˆç±»å‹å’Œç½‘ç»œç¯å¢ƒï¼Œè°ƒæ•´å†å²çŠ¶æ€çš„ä¿å­˜æ—¶é—´å’Œæ•°é‡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œå‡å°‘å»¶è¿Ÿè¡¥å¿çš„è®¡ç®—è´Ÿæ‹…
- **é˜²ä½œå¼Š**ï¼šå®ç°æ—¶é—´æˆ³éªŒè¯æœºåˆ¶ï¼Œé˜²æ­¢æ¶æ„å®¢æˆ·ç«¯å‘é€è™šå‡çš„æ—¶é—´æˆ³
- **ç”¨æˆ·ä½“éªŒ**ï¼šå¹³è¡¡å»¶è¿Ÿè¡¥å¿çš„ç²¾åº¦å’Œç³»ç»Ÿæ€§èƒ½ï¼Œç¡®ä¿æ¸¸æˆæµç•…è¿è¡Œ

### 7. ç½‘ç»œæœç´¢ç»“æœ
**ç›¸å…³èµ„æ–™**ï¼š
- æ¸¸æˆç½‘ç»œç¼–ç¨‹ç²¾è¦ - Glenn Fiedler
- ã€ŠLatency Compensating Methods in Client/Server In-game Protocol Design and Optimizationã€‹- Yahn W. Bernier
- Valveå¼€å‘è€…æ–‡æ¡£ï¼šhttps://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking
- Unityå®˜æ–¹ç½‘ç»œç¼–ç¨‹æ–‡æ¡£

**ä¿¡æ¯éªŒè¯**ï¼š
- å»¶è¿Ÿè¡¥å¿æŠ€æœ¯æ˜¯FPSæ¸¸æˆä¸­å¸¸ç”¨çš„æŠ€æœ¯ï¼Œå·²åœ¨å¤šä¸ªæˆåŠŸçš„æ¸¸æˆä¸­å¾—åˆ°éªŒè¯
- Valveçš„Sourceå¼•æ“å’ŒSource 2å¼•æ“éƒ½å®ç°äº†å»¶è¿Ÿè¡¥å¿æŠ€æœ¯
- å»¶è¿Ÿè¡¥å¿å¯ä»¥æ˜¾è‘—æé«˜ç©å®¶ä½“éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å»¶è¿Ÿç½‘ç»œç¯å¢ƒä¸‹

**æƒå¨æ¥æº**ï¼š
- Yahn W. Bernierçš„å»¶è¿Ÿè¡¥å¿è®ºæ–‡ï¼šhttps://developer.valvesoftware.com/wiki/Latency_Compensating_Methods_in_Client/Server_In-game_Protocol_Design_and_Optimization
- Valveå¼€å‘è€…æ–‡æ¡£ï¼šhttps://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking
- Glenn Fiedlerçš„ç½‘ç»œç¼–ç¨‹æ–‡ç« ï¼šhttps://gafferongames.com/
