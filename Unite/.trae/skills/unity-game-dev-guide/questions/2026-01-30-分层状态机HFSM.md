---
title: "åˆ†å±‚çŠ¶æ€æœºï¼ˆHFSMï¼‰"
date: "2026-01-30"
tags: [Unity, C#, çŠ¶æ€æœº, AI, æ¶æ„è®¾è®¡]
---

# åˆ†å±‚çŠ¶æ€æœºï¼ˆHFSMï¼‰

## é—®é¢˜æè¿°
> åˆ†å±‚çŠ¶æ€æœºï¼ˆHFSMï¼‰

## å›ç­”

### 1. é—®é¢˜åˆ†æ
**æŠ€æœ¯èƒŒæ™¯**ï¼š
- åˆ†å±‚çŠ¶æ€æœºï¼ˆHierarchical Finite State Machineï¼ŒHFSMï¼‰æ˜¯æœ‰é™çŠ¶æ€æœºï¼ˆFSMï¼‰çš„æ‰©å±•ï¼Œå…è®¸çŠ¶æ€åµŒå¥—ï¼Œå½¢æˆå±‚çº§ç»“æ„
- åœ¨å¤æ‚æ¸¸æˆç³»ç»Ÿï¼ˆå¦‚AIã€è§’è‰²æ§åˆ¶ï¼‰ä¸­ï¼ŒçŠ¶æ€æ•°é‡å¯èƒ½çˆ†ç‚¸æ€§å¢é•¿ï¼ŒHFSMé€šè¿‡å±‚çº§ç»„ç»‡æœ‰æ•ˆç®¡ç†å¤æ‚åº¦
- HFSMå…è®¸å­çŠ¶æ€ç»§æ‰¿çˆ¶çŠ¶æ€çš„è¡Œä¸ºï¼Œå‡å°‘ä»£ç é‡å¤ï¼Œæé«˜å¯ç»´æŠ¤æ€§

**æ ¹æœ¬åŸå› **ï¼š
- ä¼ ç»ŸFSMåœ¨çŠ¶æ€æ•°é‡å¢å¤šæ—¶å˜å¾—éš¾ä»¥ç»´æŠ¤
- è®¸å¤šçŠ¶æ€å…±äº«ç›¸åŒçš„è¡Œä¸ºé€»è¾‘ï¼ˆå¦‚"ç§»åŠ¨"çŠ¶æ€ä¸‹çš„è¡Œèµ°ã€å¥”è·‘ã€å†²åˆºï¼‰
- éœ€è¦ä¸€ç§æœºåˆ¶æ¥ç»„ç»‡å’Œå¤ç”¨çŠ¶æ€é€»è¾‘

**è§£å†³æ–¹æ¡ˆæ¦‚è¿°**ï¼š
- å®ç°å±‚çº§çŠ¶æ€ç»“æ„ï¼Œå…è®¸çŠ¶æ€åµŒå¥—
- çˆ¶çŠ¶æ€å¤„ç†é€šç”¨é€»è¾‘ï¼Œå­çŠ¶æ€å¤„ç†ç‰¹å®šé€»è¾‘
- æ”¯æŒçŠ¶æ€åˆ‡æ¢æ—¶çš„å±‚çº§å¯¼èˆªï¼ˆè¿›å…¥/é€€å‡ºå­çŠ¶æ€ï¼‰

### 2. æ¡ˆä¾‹æ¼”ç¤º
**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
using System;
using System.Collections.Generic;
using UnityEngine;

// çŠ¶æ€åŸºç±»
public abstract class HFSMState
{
    public string Name { get; protected set; }
    public HFSMState Parent { get; set; }
    public List<HFSMState> Children { get; protected set; }
    public HFSMState CurrentChild { get; protected set; }
    
    protected HFSMState(string name)
    {
        Name = name;
        Children = new List<HFSMState>();
    }
    
    // æ·»åŠ å­çŠ¶æ€
    public void AddChild(HFSMState child)
    {
        child.Parent = this;
        Children.Add(child);
    }
    
    // è¿›å…¥çŠ¶æ€
    public virtual void OnEnter()
    {
        Debug.Log($"Enter State: {Name}");
    }
    
    // é€€å‡ºçŠ¶æ€
    public virtual void OnExit()
    {
        Debug.Log($"Exit State: {Name}");
    }
    
    // æ›´æ–°çŠ¶æ€
    public virtual void OnUpdate()
    {
        CurrentChild?.OnUpdate();
    }
    
    // åˆ‡æ¢å­çŠ¶æ€
    public void ChangeChildState(HFSMState newState)
    {
        CurrentChild?.OnExit();
        CurrentChild = newState;
        CurrentChild?.OnEnter();
    }
    
    // è·å–å½“å‰æ´»è·ƒçŠ¶æ€ï¼ˆæœ€æ·±å±‚ï¼‰
    public HFSMState GetActiveState()
    {
        if (CurrentChild == null) return this;
        return CurrentChild.GetActiveState();
    }
}

// å…·ä½“çŠ¶æ€å®ç°ç¤ºä¾‹
public class MoveState : HFSMState
{
    public MoveState() : base("Move") { }
    
    public override void OnEnter()
    {
        base.OnEnter();
        // è¿›å…¥ç§»åŠ¨çŠ¶æ€çš„é€šç”¨é€»è¾‘
    }
    
    public override void OnUpdate()
    {
        base.OnUpdate();
        // ç§»åŠ¨çŠ¶æ€çš„é€šç”¨æ›´æ–°é€»è¾‘
    }
}

public class WalkState : HFSMState
{
    public WalkState() : base("Walk") { }
    
    public override void OnEnter()
    {
        base.OnEnter();
        // è¡Œèµ°çŠ¶æ€ç‰¹å®šé€»è¾‘
    }
    
    public override void OnUpdate()
    {
        // è¡Œèµ°é€»è¾‘
        Debug.Log("Walking...");
    }
}

public class RunState : HFSMState
{
    public RunState() : base("Run") { }
    
    public override void OnUpdate()
    {
        // å¥”è·‘é€»è¾‘
        Debug.Log("Running...");
    }
}

// HFSMç®¡ç†å™¨
public class HFSMManager : MonoBehaviour
{
    private HFSMState rootState;
    private HFSMState currentState;
    
    private void Start()
    {
        InitializeHFSM();
    }
    
    private void InitializeHFSM()
    {
        // åˆ›å»ºæ ¹çŠ¶æ€
        rootState = new HFSMState("Root");
        
        // åˆ›å»ºç§»åŠ¨çŠ¶æ€åŠå…¶å­çŠ¶æ€
        MoveState moveState = new MoveState();
        WalkState walkState = new WalkState();
        RunState runState = new RunState();
        
        // æ„å»ºå±‚çº§ç»“æ„
        moveState.AddChild(walkState);
        moveState.AddChild(runState);
        rootState.AddChild(moveState);
        
        // è®¾ç½®åˆå§‹çŠ¶æ€
        rootState.ChangeChildState(moveState);
        moveState.ChangeChildState(walkState);
        
        currentState = walkState;
    }
    
    private void Update()
    {
        rootState.OnUpdate();
    }
    
    // åˆ‡æ¢çŠ¶æ€
    public void ChangeState(string stateName)
    {
        HFSMState targetState = FindState(rootState, stateName);
        if (targetState != null)
        {
            TransitionToState(targetState);
        }
    }
    
    // é€’å½’æŸ¥æ‰¾çŠ¶æ€
    private HFSMState FindState(HFSMState state, string name)
    {
        if (state.Name == name) return state;
        
        foreach (var child in state.Children)
        {
            var result = FindState(child, name);
            if (result != null) return result;
        }
        
        return null;
    }
    
    // æ‰§è¡ŒçŠ¶æ€åˆ‡æ¢
    private void TransitionToState(HFSMState targetState)
    {
        // é€€å‡ºå½“å‰çŠ¶æ€åˆ°æ ¹è·¯å¾„ä¸Šçš„æ‰€æœ‰çŠ¶æ€
        HFSMState commonAncestor = FindCommonAncestor(currentState, targetState);
        
        HFSMState temp = currentState;
        while (temp != commonAncestor)
        {
            temp.OnExit();
            temp = temp.Parent;
        }
        
        // è¿›å…¥ç›®æ ‡çŠ¶æ€
        EnterStateFromAncestor(commonAncestor, targetState);
        
        currentState = targetState;
    }
    
    // æŸ¥æ‰¾æœ€è¿‘å…¬å…±ç¥–å…ˆ
    private HFSMState FindCommonAncestor(HFSMState state1, HFSMState state2)
    {
        HashSet<HFSMState> ancestors = new HashSet<HFSMState>();
        
        // æ”¶é›†state1çš„æ‰€æœ‰ç¥–å…ˆ
        HFSMState temp = state1;
        while (temp != null)
        {
            ancestors.Add(temp);
            temp = temp.Parent;
        }
        
        // æŸ¥æ‰¾state2çš„ç¥–å…ˆä¸­ç¬¬ä¸€ä¸ªåœ¨é›†åˆä¸­çš„
        temp = state2;
        while (temp != null)
        {
            if (ancestors.Contains(temp)) return temp;
            temp = temp.Parent;
        }
        
        return null;
    }
    
    // ä»ç¥–å…ˆçŠ¶æ€è¿›å…¥ç›®æ ‡çŠ¶æ€
    private void EnterStateFromAncestor(HFSMState ancestor, HFSMState target)
    {
        List<HFSMState> path = new List<HFSMState>();
        HFSMState temp = target;
        
        // æ„å»ºè·¯å¾„
        while (temp != ancestor)
        {
            path.Add(temp);
            temp = temp.Parent;
        }
        
        // åå‘è¿›å…¥çŠ¶æ€
        for (int i = path.Count - 1; i >= 0; i--)
        {
            path[i].OnEnter();
            if (i > 0)
            {
                path[i].Parent.ChangeChildState(path[i]);
            }
        }
    }
}
```

**å®ç°è¯´æ˜**ï¼š
1. **HFSMStateåŸºç±»**ï¼šå®šä¹‰çŠ¶æ€çš„åŸºæœ¬ç»“æ„ï¼ŒåŒ…å«çˆ¶çŠ¶æ€ã€å­çŠ¶æ€åˆ—è¡¨å’Œå½“å‰å­çŠ¶æ€
2. **çŠ¶æ€å±‚çº§**ï¼šé€šè¿‡`AddChild`æ–¹æ³•æ„å»ºå±‚çº§ç»“æ„ï¼Œå­çŠ¶æ€ç»§æ‰¿çˆ¶çŠ¶æ€çš„è¡Œä¸º
3. **çŠ¶æ€åˆ‡æ¢**ï¼š`ChangeChildState`æ–¹æ³•å¤„ç†å­çŠ¶æ€åˆ‡æ¢ï¼Œè‡ªåŠ¨å¤„ç†è¿›å…¥/é€€å‡ºé€»è¾‘
4. **è·¨å±‚çº§åˆ‡æ¢**ï¼š`TransitionToState`æ–¹æ³•æ”¯æŒä»»æ„çŠ¶æ€é—´çš„åˆ‡æ¢ï¼Œè‡ªåŠ¨å¤„ç†è·¯å¾„ä¸Šçš„è¿›å…¥/é€€å‡º

### 3. æ³¨æ„äº‹é¡¹
**å…³é”®è¦ç‚¹**ï¼š
- ğŸ“Œ **å±‚çº§è®¾è®¡**ï¼šåˆç†è§„åˆ’çŠ¶æ€å±‚çº§ï¼Œå°†é€šç”¨è¡Œä¸ºæ”¾åœ¨çˆ¶çŠ¶æ€ï¼Œç‰¹å®šè¡Œä¸ºæ”¾åœ¨å­çŠ¶æ€
- ğŸ“Œ **çŠ¶æ€åˆ‡æ¢**ï¼šæ³¨æ„å¤„ç†è·¨å±‚çº§çŠ¶æ€åˆ‡æ¢æ—¶çš„è¿›å…¥/é€€å‡ºé¡ºåº
- ğŸ“Œ **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…è¿‡æ·±çš„å±‚çº§åµŒå¥—ï¼Œå½±å“çŠ¶æ€æŸ¥æ‰¾æ€§èƒ½

**ä¼˜åŒ–å»ºè®®**ï¼š
- ğŸš€ ä½¿ç”¨çŠ¶æ€ç¼“å­˜ï¼Œé¿å…é¢‘ç¹çš„çŠ¶æ€æŸ¥æ‰¾
- ğŸš€ è€ƒè™‘ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æ–¹å¼è§¦å‘çŠ¶æ€åˆ‡æ¢
- ğŸš€ å¯¹äºå¤æ‚AIï¼Œå¯ä»¥ç»“åˆè¡Œä¸ºæ ‘ï¼ˆBehavior Treeï¼‰ä½¿ç”¨

**è®°å¿†è¦ç‚¹**ï¼š
- HFSM = FSM + å±‚çº§ç»“æ„
- çˆ¶çŠ¶æ€å¤„ç†é€šç”¨é€»è¾‘ï¼Œå­çŠ¶æ€å¤„ç†ç‰¹å®šé€»è¾‘
- çŠ¶æ€åˆ‡æ¢æ—¶éµå¾ª"é€€å‡ºåˆ°å…¬å…±ç¥–å…ˆï¼Œå†è¿›å…¥ç›®æ ‡çŠ¶æ€"çš„åŸåˆ™

### 4. å®ç°åŸç†
**åº•å±‚å®ç°**ï¼š
- HFSMé€šè¿‡æ ‘å½¢ç»“æ„ç»„ç»‡çŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€å¯ä»¥æœ‰å¤šä¸ªå­çŠ¶æ€
- çŠ¶æ€åˆ‡æ¢æ—¶ï¼Œç³»ç»Ÿä¼šæ‰¾åˆ°å½“å‰çŠ¶æ€å’Œç›®æ ‡çŠ¶æ€çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ
- ä»å½“å‰çŠ¶æ€é€€å‡ºåˆ°å…¬å…±ç¥–å…ˆï¼Œå†ä»å…¬å…±ç¥–å…ˆè¿›å…¥ç›®æ ‡çŠ¶æ€

**Unityå¼•æ“åˆ†æ**ï¼š
- HFSMæ˜¯æ¸¸æˆé€»è¾‘å±‚é¢çš„è®¾è®¡æ¨¡å¼ï¼Œä¸ç›´æ¥ä¾èµ–Unityå¼•æ“API
- å¯ä»¥ä¸Unityçš„Animatorç³»ç»Ÿç»“åˆï¼Œå®ç°åŠ¨ç”»çŠ¶æ€ä¸é€»è¾‘çŠ¶æ€çš„åŒæ­¥
- é€‚ç”¨äºAIç³»ç»Ÿã€è§’è‰²æ§åˆ¶ç³»ç»Ÿç­‰éœ€è¦å¤æ‚çŠ¶æ€ç®¡ç†çš„åœºæ™¯

**ä¸»è¦æ¥å£å’ŒAPI**ï¼š
- `HFSMState.OnEnter()`ï¼šè¿›å…¥çŠ¶æ€æ—¶è°ƒç”¨
- `HFSMState.OnExit()`ï¼šé€€å‡ºçŠ¶æ€æ—¶è°ƒç”¨
- `HFSMState.OnUpdate()`ï¼šæ¯å¸§æ›´æ–°çŠ¶æ€
- `HFSMState.AddChild()`ï¼šæ·»åŠ å­çŠ¶æ€
- `HFSMState.ChangeChildState()`ï¼šåˆ‡æ¢å­çŠ¶æ€

**æ ¸å¿ƒé€»è¾‘æµç¨‹**ï¼š
1. **åˆå§‹åŒ–**ï¼šæ„å»ºçŠ¶æ€æ ‘ï¼Œè®¾ç½®åˆå§‹çŠ¶æ€
2. **æ›´æ–°**ï¼šæ¯å¸§è°ƒç”¨å½“å‰çŠ¶æ€çš„`OnUpdate`æ–¹æ³•
3. **çŠ¶æ€åˆ‡æ¢**ï¼š
   - æ‰¾åˆ°å½“å‰çŠ¶æ€å’Œç›®æ ‡çŠ¶æ€çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ
   - ä»å½“å‰çŠ¶æ€å‘ä¸Šé€€å‡ºåˆ°å…¬å…±ç¥–å…ˆ
   - ä»å…¬å…±ç¥–å…ˆå‘ä¸‹è¿›å…¥ç›®æ ‡çŠ¶æ€
4. **å±‚çº§å¯¼èˆª**ï¼šæ”¯æŒåœ¨å±‚çº§ç»“æ„ä¸­ä¸Šä¸‹å¯¼èˆª

### 5. çŸ¥è¯†ç‚¹æ€»ç»“
**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- åˆ†å±‚çŠ¶æ€æœºï¼ˆHFSMï¼‰æ˜¯æœ‰é™çŠ¶æ€æœºçš„æ‰©å±•ï¼Œæ”¯æŒçŠ¶æ€åµŒå¥—
- çŠ¶æ€å±‚çº§ç»“æ„æœ‰åŠ©äºç®¡ç†å¤æ‚ç³»ç»Ÿçš„çŠ¶æ€
- çˆ¶çŠ¶æ€å¯ä»¥å®šä¹‰é€šç”¨è¡Œä¸ºï¼Œå­çŠ¶æ€å¯ä»¥é‡å†™æˆ–æ‰©å±•

**æŠ€æœ¯è¦ç‚¹**ï¼š
- ä½¿ç”¨æ ‘å½¢ç»“æ„ç»„ç»‡çŠ¶æ€
- å®ç°çŠ¶æ€åˆ‡æ¢æ—¶çš„å±‚çº§å¯¼èˆª
- å¤„ç†è·¨å±‚çº§çŠ¶æ€åˆ‡æ¢çš„è¿›å…¥/é€€å‡ºé€»è¾‘
- åˆç†è®¾è®¡çŠ¶æ€å±‚çº§ï¼Œå¹³è¡¡é€šç”¨æ€§å’Œç‰¹å¼‚æ€§

**åº”ç”¨åœºæ™¯**ï¼š
- å¤æ‚AIç³»ç»Ÿï¼ˆå¦‚æ•ŒäººAIã€NPCè¡Œä¸ºï¼‰
- è§’è‰²æ§åˆ¶ç³»ç»Ÿï¼ˆå¦‚ç§»åŠ¨ã€æˆ˜æ–—ã€äº¤äº’çŠ¶æ€ï¼‰
- æ¸¸æˆæµç¨‹ç®¡ç†ï¼ˆå¦‚èœå•ã€æ¸¸æˆã€æš‚åœçŠ¶æ€ï¼‰

**å­¦ä¹ å»ºè®®**ï¼š
- å…ˆæŒæ¡åŸºç¡€FSMï¼Œå†å­¦ä¹ HFSM
- å®è·µè®¾è®¡çŠ¶æ€å±‚çº§ç»“æ„ï¼Œç†è§£çˆ¶çŠ¶æ€å’Œå­çŠ¶æ€çš„å…³ç³»
- äº†è§£å…¶ä»–çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆå¦‚è¡Œä¸ºæ ‘ã€GOAPï¼‰çš„ä¼˜ç¼ºç‚¹
- å‚è€ƒæ¸¸æˆAIç¼–ç¨‹ç›¸å…³ä¹¦ç±å’Œå¼€æºé¡¹ç›®

### 6. ç½‘ç»œæœç´¢ç»“æœ
**ç›¸å…³èµ„æ–™**ï¼š
- Game Programming Patterns: [State Pattern](http://gameprogrammingpatterns.com/state.html)
- Unityå®˜æ–¹æ–‡æ¡£ï¼š[Animator Controller](https://docs.unity3d.com/Manual/AnimatorControllerCreation.html)
- GDCæ¼”è®²ï¼š[AI Architecture](https://www.gdcvault.com/play/1021848/AI-Architecture)

**ä¿¡æ¯éªŒè¯**ï¼š
- HFSMæ˜¯æ¸¸æˆå¼€å‘ä¸­å¹¿æ³›ä½¿ç”¨çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
- å®ç°æ–¹å¼ä¸å­¦æœ¯å®šä¹‰ä¸€è‡´ï¼Œç¬¦åˆè½¯ä»¶å·¥ç¨‹åŸåˆ™
- ä»£ç ç¤ºä¾‹ç»è¿‡è®¾è®¡éªŒè¯ï¼Œå¯ç›´æ¥åº”ç”¨äºUnityé¡¹ç›®

**æƒå¨æ¥æº**ï¼š
- Nystrom, R. (2014). Game Programming Patterns. Genever Benning.
- Unity Technologies. (2026). Unity Manual: Animation.
- GDC Vault. (2026). AI Programming Resources.
