---
title: "DOTS æŠ€æœ¯æ ˆ"
date: "2026-01-30"
tags: [Unity, C#, DOTS, ECS, æ€§èƒ½ä¼˜åŒ–]
---

# DOTS æŠ€æœ¯æ ˆ

## é—®é¢˜æè¿°
DOTSï¼ˆData-Oriented Technology Stackï¼‰æŠ€æœ¯æ ˆæ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿåœ¨Unityæ¸¸æˆå¼€å‘ä¸­æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

## å›ç­”

### 1. é—®é¢˜åˆ†æ

**æŠ€æœ¯èƒŒæ™¯**ï¼š
- DOTS æ˜¯ Unity æ¨å‡ºçš„é«˜æ€§èƒ½ç¼–ç¨‹æ¡†æ¶ï¼Œæ—¨åœ¨å……åˆ†åˆ©ç”¨ç°ä»£ç¡¬ä»¶æ€§èƒ½
- åŒ…å«ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼šECSï¼ˆEntity Component Systemï¼‰ã€Job Systemã€Burst Compiler
- ä¼ ç»Ÿçš„ MonoBehaviour æ¶æ„åœ¨å¤„ç†å¤§é‡æ¸¸æˆå¯¹è±¡æ—¶æ€§èƒ½å—é™

**æ ¹æœ¬åŸå› **ï¼š
- é¢å‘å¯¹è±¡ï¼ˆOOPï¼‰è®¾è®¡å¯¼è‡´æ•°æ®åˆ†æ•£ï¼Œä¸åˆ©äº CPU ç¼“å­˜
- å•çº¿ç¨‹æ‰§è¡Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨
- é¢‘ç¹çš„ GC æ“ä½œå½±å“æ¸¸æˆæ€§èƒ½
- å†…å­˜è®¿é—®æ¨¡å¼ä¸å‹å¥½ï¼Œå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡ä½

**è§£å†³æ–¹æ¡ˆæ¦‚è¿°**ï¼š
- ä½¿ç”¨ ECS æ¶æ„ç»„ç»‡æ•°æ®ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
- ä½¿ç”¨ Job System å®ç°å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†
- ä½¿ç”¨ Burst Compiler ç¼–è¯‘é«˜æ€§èƒ½åŸç”Ÿä»£ç 
- é‡‡ç”¨æ•°æ®å¯¼å‘è®¾è®¡ï¼ˆDODï¼‰ç†å¿µï¼Œä¼˜åŒ–å†…å­˜è®¿é—®

### 2. æ¡ˆä¾‹æ¼”ç¤º

#### 2.1 åŸºç¡€ ECS ç¤ºä¾‹

```csharp
using Unity.Burst;
using Unity.Collections;
using Unity.Entities;
using Unity.Mathematics;
using Unity.Transforms;
using UnityEngine;

// ç»„ä»¶å®šä¹‰ï¼ˆçº¯æ•°æ®ï¼‰
public struct MovementData : IComponentData
{
    public float3 Direction;
    public float Speed;
}

public struct RotationData : IComponentData
{
    public float RotationSpeed;
}

// ç³»ç»Ÿå®šä¹‰ï¼ˆè¡Œä¸ºé€»è¾‘ï¼‰
[BurstCompile]
public partial struct MovementSystem : ISystem
{
    public void OnCreate(ref SystemState state)
    {
        // ç³»ç»Ÿåˆå§‹åŒ–
    }

    public void OnDestroy(ref SystemState state)
    {
        // ç³»ç»Ÿé”€æ¯
    }

    [BurstCompile]
    public void OnUpdate(ref SystemState state)
    {
        float deltaTime = SystemAPI.Time.DeltaTime;
        
        // æŸ¥è¯¢æ‰€æœ‰å…·æœ‰ LocalTransform å’Œ MovementData çš„å®ä½“
        foreach (var (transform, movement) in 
            SystemAPI.Query<RefRW<LocalTransform>, RefRO<MovementData>>())
        {
            // æ›´æ–°ä½ç½®
            float3 newPosition = transform.ValueRO.Position + 
                movement.ValueRO.Direction * movement.ValueRO.Speed * deltaTime;
            
            transform.ValueRW.Position = newPosition;
        }
    }
}

// MonoBehaviour ç”¨äºåœ¨åœºæ™¯ä¸­åˆ›å»º DOTS å®ä½“
public class DOTSSpawner : MonoBehaviour
{
    [SerializeField] private GameObject prefab;
    [SerializeField] private int spawnCount = 1000;
    
    void Start()
    {
        // è·å–å®ä½“ç®¡ç†å™¨
        var entityManager = World.DefaultGameObjectInjectionWorld.EntityManager;
        
        // åˆ›å»ºå®ä½“åŸå‹
        var entityPrefab = entityManager.CreateEntity();
        entityManager.AddComponent<LocalTransform>(entityPrefab);
        entityManager.AddComponent<MovementData>(entityPrefab);
        entityManager.AddComponent<RotationData>(entityPrefab);
        
        // æ‰¹é‡åˆ›å»ºå®ä½“
        NativeArray<Entity> entities = new NativeArray<Entity>(spawnCount, Allocator.Temp);
        entityManager.Instantiate(entityPrefab, entities);
        
        // åˆå§‹åŒ–å®ä½“æ•°æ®
        for (int i = 0; i < spawnCount; i++)
        {
            entityManager.SetComponentData(entities[i], new MovementData
            {
                Direction = new float3(
                    UnityEngine.Random.Range(-1f, 1f),
                    0,
                    UnityEngine.Random.Range(-1f, 1f)
                ),
                Speed = UnityEngine.Random.Range(1f, 5f)
            });
            
            entityManager.SetComponentData(entities[i], new RotationData
            {
                RotationSpeed = UnityEngine.Random.Range(10f, 100f)
            });
            
            entityManager.SetComponentData(entities[i], new LocalTransform
            {
                Position = new float3(
                    UnityEngine.Random.Range(-50f, 50f),
                    0,
                    UnityEngine.Random.Range(-50f, 50f)
                ),
                Rotation = quaternion.identity,
                Scale = 1f
            });
        }
        
        entities.Dispose();
    }
}
```

#### 2.2 Job System + ECS ç¤ºä¾‹

```csharp
using Unity.Burst;
using Unity.Collections;
using Unity.Entities;
using Unity.Jobs;
using Unity.Mathematics;
using Unity.Transforms;

// ä½¿ç”¨ Job çš„ç³»ç»Ÿ
[BurstCompile]
public partial struct JobMovementSystem : ISystem
{
    public void OnCreate(ref SystemState state)
    {
    }

    public void OnDestroy(ref SystemState state)
    {
    }

    [BurstCompile]
    public void OnUpdate(ref SystemState state)
    {
        // åˆ›å»º Job
        var job = new MovementJob
        {
            DeltaTime = SystemAPI.Time.DeltaTime
        };
        
        // è°ƒåº¦ Job
        state.Dependency = job.ScheduleParallel(state.Dependency);
    }
}

[BurstCompile]
public partial struct MovementJob : IJobEntity
{
    public float DeltaTime;
    
    // è‡ªåŠ¨åŒ¹é…å…·æœ‰è¿™äº›ç»„ä»¶çš„å®ä½“
    void Execute(ref LocalTransform transform, in MovementData movement)
    {
        transform.Position += movement.Direction * movement.Speed * DeltaTime;
    }
}
```

#### 2.3 æ‰¹é‡å¤„ç†ç¤ºä¾‹

```csharp
using Unity.Burst;
using Unity.Collections;
using Unity.Entities;
using Unity.Jobs;
using Unity.Mathematics;
using Unity.Transforms;

// é«˜æ•ˆçš„æ‰¹é‡å¤„ç†ç³»ç»Ÿ
[BurstCompile]
public partial struct BatchProcessingSystem : ISystem
{
    private EntityQuery query;
    
    public void OnCreate(ref SystemState state)
    {
        // åˆ›å»ºæŸ¥è¯¢ï¼Œç­›é€‰éœ€è¦å¤„ç†çš„å®ä½“
        query = state.GetEntityQuery(
            ComponentType.ReadOnly<MovementData>(),
            ComponentType.ReadWrite<LocalTransform>()
        );
    }

    public void OnDestroy(ref SystemState state)
    {
    }

    [BurstCompile]
    public void OnUpdate(ref SystemState state)
    {
        // è·å–ç»„ä»¶æ•°ç»„ï¼ˆè¿ç»­å†…å­˜å¸ƒå±€ï¼‰
        var transforms = query.ToComponentDataArray<LocalTransform>(Allocator.TempJob);
        var movements = query.ToComponentDataArray<MovementData>(Allocator.TempJob);
        
        // åˆ›å»º Job
        var job = new BatchMovementJob
        {
            Transforms = transforms,
            Movements = movements,
            DeltaTime = SystemAPI.Time.DeltaTime
        };
        
        // è°ƒåº¦å¹¶è¡Œ Job
        state.Dependency = job.Schedule(transforms.Length, 64, state.Dependency);
        state.Dependency.Complete();
        
        // å°†ç»“æœå†™å›
        query.CopyFromComponentDataArray(transforms);
        
        transforms.Dispose();
        movements.Dispose();
    }
}

[BurstCompile]
public struct BatchMovementJob : IJobParallelFor
{
    public NativeArray<LocalTransform> Transforms;
    [ReadOnly] public NativeArray<MovementData> Movements;
    public float DeltaTime;
    
    public void Execute(int index)
    {
        var transform = Transforms[index];
        var movement = Movements[index];
        
        transform.Position += movement.Direction * movement.Speed * DeltaTime;
        Transforms[index] = transform;
    }
}
```

### 3. æ³¨æ„äº‹é¡¹

#### 3.1 å…³é”®è¦ç‚¹

- ğŸ“Œ **æ•°æ®å¸ƒå±€**ï¼šECS ä½¿ç”¨ SoAï¼ˆStructure of Arraysï¼‰å¸ƒå±€ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
- ğŸ“Œ **ç»„ä»¶é™åˆ¶**ï¼šç»„ä»¶å¿…é¡»æ˜¯å€¼ç±»å‹ï¼ˆstructï¼‰ï¼Œä¸èƒ½åŒ…å«å¼•ç”¨ç±»å‹
- ğŸ“Œ **ç³»ç»Ÿæ›´æ–°**ï¼šæ³¨æ„ç³»ç»Ÿä¾èµ–å…³ç³»ï¼Œé¿å…ç«äº‰æ¡ä»¶
- ğŸ“Œ **å†…å­˜ç®¡ç†**ï¼šä½¿ç”¨ Unity.Collections å‘½åç©ºé—´ä¸‹çš„ç±»å‹ï¼Œæ‰‹åŠ¨ç®¡ç†å†…å­˜
- ğŸ“Œ **çº¿ç¨‹å®‰å…¨**ï¼šJob ä¸­è®¿é—®çš„æ•°æ®å¿…é¡»æ˜¯åªè¯»æˆ–æœ‰é€‚å½“çš„åŒæ­¥æªæ–½

#### 3.2 ä¼˜åŒ–å»ºè®®

- ğŸš€ **ä½¿ç”¨ EntityQuery**ï¼šæ‰¹é‡å¤„ç†å®ä½“ï¼Œå‡å°‘éå†å¼€é”€
- ğŸš€ **åˆç†ä½¿ç”¨ BurstCompile**ï¼šå¯¹è®¡ç®—å¯†é›†å‹ä»£ç ä½¿ç”¨ Burst ç¼–è¯‘
- ğŸš€ **ä½¿ç”¨ Unity.Mathematics**ï¼šåˆ©ç”¨ SIMD æŒ‡ä»¤ä¼˜åŒ–æ•°å­¦è¿ç®—
- ğŸš€ **é¿å…è™šå‡½æ•°å’Œæ¥å£**ï¼šåœ¨ ECS ä¸­ä½¿ç”¨è™šå‡½æ•°ä¼šé™ä½æ€§èƒ½
- ğŸš€ **ç»„ä»¶è®¾è®¡**ï¼šå°†ç›¸å…³æ•°æ®ç»„åˆåˆ°åŒä¸€ç»„ä»¶ä¸­ï¼Œå‡å°‘ç»„ä»¶æ•°é‡
- ğŸš€ **å†…å­˜åˆ†é…**ï¼šå°½é‡ä½¿ç”¨æ ˆåˆ†é…å’Œå¯¹è±¡æ± ï¼Œå‡å°‘å †åˆ†é…

#### 3.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **å†…å­˜æ³„æ¼** | NativeArray ç­‰èµ„æºæœªæ­£ç¡®é‡Šæ”¾ | ä½¿ç”¨ using è¯­å¥æˆ–æ‰‹åŠ¨è°ƒç”¨ Dispose() |
| **çº¿ç¨‹ç«äº‰** | å¤šä¸ª Job åŒæ—¶ä¿®æ”¹ç›¸åŒæ•°æ® | ä½¿ç”¨ IJobEntity æˆ–é€‚å½“çš„åŒæ­¥æœºåˆ¶ |
| **æ€§èƒ½æå‡ä¸æ˜æ˜¾** | æœªå……åˆ†åˆ©ç”¨ DOTS ç‰¹æ€§ | æ£€æŸ¥å†…å­˜è®¿é—®æ¨¡å¼ï¼Œç¡®ä¿æ•°æ®è¿ç»­ |
| **å­¦ä¹ æ›²çº¿é™¡å³­** | DOTS æ¦‚å¿µå’Œä¼ ç»Ÿ OOP å·®å¼‚å¤§ | ä»ç®€å•é¡¹ç›®å¼€å§‹ï¼Œé€æ­¥å­¦ä¹  |
| **ä¸ç°æœ‰ä»£ç é›†æˆå›°éš¾** | ä¼ ç»Ÿ MonoBehaviour ä¸ ECS æ¶æ„å·®å¼‚ | ä½¿ç”¨ GameObjectEntity æˆ–æ··åˆæ¶æ„ |

### 4. å®ç°åŸç†

**åº•å±‚å®ç°**ï¼š
- **ECS æ¶æ„**ï¼šEntityï¼ˆIDï¼‰+ Componentï¼ˆæ•°æ®ï¼‰+ Systemï¼ˆé€»è¾‘ï¼‰
- **Archetype**ï¼šå…·æœ‰ç›¸åŒç»„ä»¶ç»„åˆçš„å®ä½“å…±äº«å†…å­˜å¸ƒå±€
- **Chunk**ï¼šå›ºå®šå¤§å°çš„å†…å­˜å—ï¼Œå­˜å‚¨åŒç±»å‹å®ä½“æ•°æ®
- **SoA å¸ƒå±€**ï¼šæŒ‰ç»„ä»¶ç±»å‹å­˜å‚¨æ•°æ®ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡

**Unityå¼•æ“åˆ†æ**ï¼š
- **World**ï¼šåŒ…å«æ‰€æœ‰å®ä½“å’Œç³»ç»Ÿçš„å®¹å™¨
- **EntityManager**ï¼šç®¡ç†å®ä½“çš„åˆ›å»ºã€é”€æ¯å’Œç»„ä»¶æ“ä½œ
- **SystemGroup**ï¼šç»„ç»‡ç³»ç»Ÿæ‰§è¡Œé¡ºåºï¼Œå¤„ç†ç³»ç»Ÿä¾èµ–
- **Job System**ï¼šUnity çš„å¤šçº¿ç¨‹ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ
- **Burst Compiler**ï¼šåŸºäº LLVM çš„ä¼˜åŒ–ç¼–è¯‘å™¨ï¼Œç”Ÿæˆé«˜æ•ˆåŸç”Ÿä»£ç 

**æ ¸å¿ƒæ‰§è¡Œæµç¨‹**ï¼š
1. **åˆ›å»º World**ï¼šåˆå§‹åŒ– ECS ä¸–ç•Œï¼Œæ³¨å†Œç³»ç»Ÿ
2. **å®šä¹‰ç»„ä»¶**ï¼šåˆ›å»ºçº¯æ•°æ®ç»“æ„ï¼Œå®ç° IComponentData æ¥å£
3. **åˆ›å»ºç³»ç»Ÿ**ï¼šå®ç° ISystem æ¥å£ï¼Œå®šä¹‰å®ä½“è¡Œä¸º
4. **åˆ›å»ºå®ä½“**ï¼šé€šè¿‡ EntityManager åˆ›å»ºå®ä½“ï¼Œæ·»åŠ ç»„ä»¶
5. **ç³»ç»Ÿæ›´æ–°**ï¼šæ¯å¸§æ‰§è¡Œç³»ç»Ÿé€»è¾‘ï¼Œå¤„ç†å®ä½“
6. **Job è°ƒåº¦**ï¼šå°†è®¡ç®—ä»»åŠ¡åˆ†è§£ä¸º Jobï¼Œå¹¶è¡Œæ‰§è¡Œ

### 5. ç»“è®º

DOTS æŠ€æœ¯æ ˆæ˜¯ Unity ä¸ºäº†è§£å†³ä¼ ç»Ÿæ¸¸æˆå¼€å‘ä¸­çš„æ€§èƒ½ç“¶é¢ˆè€Œæ¨å‡ºçš„é«˜æ€§èƒ½ç¼–ç¨‹æ¡†æ¶ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§å®ç°æ€§èƒ½æå‡ï¼š

- **æ•°æ®å¯¼å‘è®¾è®¡**ï¼šä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
- **å¹¶è¡Œè®¡ç®—**ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨
- **é«˜æ•ˆç¼–è¯‘**ï¼šç”Ÿæˆä¼˜åŒ–çš„åŸç”Ÿä»£ç 
- **æ‰¹é‡å¤„ç†**ï¼šå‡å°‘å¼€é”€ï¼Œæé«˜ååé‡

**åº”ç”¨åœºæ™¯**ï¼š
- å¤§è§„æ¨¡æ¨¡æ‹Ÿï¼ˆå¦‚ä¸‡äººåŒå±ï¼‰
- å¤æ‚ç‰©ç†æ¨¡æ‹Ÿ
- ç¨‹åºåŒ–ç”Ÿæˆ
- é«˜æ€§èƒ½ AI
- ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
- ä»»ä½•éœ€è¦å¤„ç†å¤§é‡æ¸¸æˆå¯¹è±¡çš„åœºæ™¯

**å­¦ä¹ å»ºè®®**ï¼š
- ä»ç®€å•çš„ ECS é¡¹ç›®å¼€å§‹ï¼Œé€æ­¥æŒæ¡æ ¸å¿ƒæ¦‚å¿µ
- å­¦ä¹ æ•°æ®å¯¼å‘è®¾è®¡ï¼ˆDODï¼‰ç†å¿µ
- äº†è§£ CPU ç¼“å­˜å’Œå†…å­˜è®¿é—®æ¨¡å¼
- å‚è€ƒ Unity ECS Samples é¡¹ç›®
- ç»“åˆå®é™…é¡¹ç›®éœ€æ±‚ï¼Œé€æ­¥è¿ç§»åˆ° DOTS æ¶æ„

DOTS ä»£è¡¨äº†æ¸¸æˆå¼€å‘çš„æœªæ¥æ–¹å‘ï¼Œé€šè¿‡é‡‡ç”¨æ•°æ®å¯¼å‘è®¾è®¡å’Œç°ä»£ç¡¬ä»¶ä¼˜åŒ–æŠ€æœ¯ï¼Œä¸ºå¼€å‘è€…æä¾›äº†æ„å»ºé«˜æ€§èƒ½æ¸¸æˆçš„å¼ºå¤§å·¥å…·ã€‚è™½ç„¶å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ï¼Œä½†æŒæ¡ DOTS åï¼Œä½ å°†èƒ½å¤Ÿå¼€å‘å‡ºæ€§èƒ½æ›´ä¼˜ã€è§„æ¨¡æ›´å¤§çš„æ¸¸æˆé¡¹ç›®ã€‚
