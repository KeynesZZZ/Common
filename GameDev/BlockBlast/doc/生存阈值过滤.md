# 生存阈值过滤 (Survival Threshold Filtering)

系统会根据你当前的分数和剩余空格数设定一个"存活概率权重"：

- **空格数 > 20**：随机性较强，系统会倾向于给你一些"占位置"的大块，消耗你的空间。
- **空格数 < 10**：进入"紧急模式"。此时，算法会严格筛选：
  - **低分段**：筛选出至少能产生一次消除的方块。
  - **高分段**：筛选出"能放下但无法消除"的方块，故意填满你的最后一点生机。

---

在《Block Blast!》的底层设计中，**生存阈值过滤（Survival Threshold Filtering）**是调节游戏"心跳"的阀门。它决定了系统何时该对你"温柔"，何时该下"死手"。

如果说影子棋盘模拟是**"看能不能放下"**，那么生存阈值过滤就是根据你的实时表现，决定**"要不要给你生路"**。

## 1. C# 逻辑实现：生存阈值控制器

我们可以通过一个概率加权器来实现这个过滤机制，它会根据棋盘剩余空间的百分比，动态筛选影子模拟的结果。

```csharp
public class SurvivalThresholdFilter
{
    private const int TotalCells = 64;

    public enum DifficultyMode { Mercy, Neutral, Execution } // 仁慈、中立、处决模式

    /// <summary>
    /// 根据当前棋盘状态决定发牌策略
    /// </summary>
    public List<int[,]> FilterCandidateSets(List<List<int[,]>> potentialSets, int[,] board, int score)
    {
        int emptyCells = CountEmptyCells(board);
        float fillRate = (TotalCells - emptyCells) / (float)TotalCells;

        // 1. 确定当前的难度模式
        DifficultyMode mode = DetermineMode(fillRate, score);

        // 2. 对所有候选方案进行生存评估
        var scoredSets = potentialSets.Select(set => new {
            Blocks = set,
            Result = ShadowSim.EvaluateSet(board, set)
        }).ToList();

        // 3. 过滤逻辑
        switch (mode)
        {
            case DifficultyMode.Mercy:
                // 仁慈模式：必须选一个能放下且碎片化最低的方案
                return scoredSets.Where(s => s.Result.IsViable)
                                 .OrderBy(s => s.Result.Fragments)
                                 .First().Blocks;

            case DifficultyMode.Execution:
                // 处决模式：优先选"不致死但最难受"的方案
                // 比如：碎片化极高，且潜在消除行数为 0 的组合
                return scoredSets.Where(s => s.Result.IsViable)
                                 .OrderByDescending(s => s.Result.Fragments)
                                 .ThenBy(s => s.Result.PotentialLines)
                                 .First().Blocks;

            default:
                return scoredSets[new Random().Next(scoredSets.Count)].Blocks;
        }
    }

    private DifficultyMode DetermineMode(float fillRate, int score)
    {
        if (fillRate > 0.85f) return DifficultyMode.Mercy;      // 棋盘快满了，给点简单的块续命（为了留住玩家）
        if (score > 5000 && fillRate > 0.6f) return DifficultyMode.Execution; // 高分段且空间局促，开启处决
        return DifficultyMode.Neutral;
    }
}
```

## 2. 生存阈值的三个关键阶段

### A. 仁慈区域（Mercy Zone）：空间充足或濒临死亡

- **触发条件**：棋盘空格率 $> 70\%$ 或极其局促（$< 15\%$）。
- **策略**：当你快死的时候，系统为了防止你因为挫败感退游，会触发"低保机制"。影子模拟会过滤掉所有导致 `IsViable = false` 的组合，强行塞给你能放下的方块，甚至是能救命的消行块。

### B. 压力测试区（Pressure Zone）：常规博弈

- **触发条件**：棋盘空格率在 $30\% - 60\%$ 之间。
- **策略**：这是游戏最"平衡"的时候。系统会通过 `Fragments`（碎片化）指标来测试你的整理能力。它会发给你一些形状互补但需要技巧放置的方块，观察你是否会把大块空间切碎。

### C. 处决区域（Execution Zone）：收割时刻

- **触发条件**：高分段 + 空间利用率达到临界点。
- **策略**：此时阈值过滤会变得非常"冷酷"。它会搜索影子棋盘中最差的连通性结果。
- **隐藏规则**：如果影子模拟发现某种组合放下去后，剩余空位中没有任何一个能容纳下一次可能出现的 $3 \times 3$ 或 $5 \times 1$，那么这个组合会被高优先级推送给你。

## 3. 为什么这个机制让你"欲罢不能"？

生存阈值过滤实际上是在控制多巴胺的释放节奏：

- **绝境逢生的错觉**：当你以为必死时，阈值过滤切换到 Mercy 模式，给了你一个长条，让你完成一次 4 行连消，产生"我技术真好"的错觉。
- **慢性死亡的焦虑**：在 Execution 模式下，它不直接杀掉你，而是每次都给你稍微"硌手"的块，看着你的棋盘一点点变乱，直到你产生"只要刚才那一手不放那里就好了"的懊悔感，从而立刻开始下一局。

## 总结

生存阈值过滤不是为了公平，而是为了留存（Retention）。它利用影子模拟的结果，像调音师一样实时拨动游戏的难度弦。

---

既然看过了处决模式的逻辑，你想了解一下如何通过一种叫做"边缘堆叠"的策略，来欺骗这个阈值过滤算法，让它判定你还不需要被处决吗？
